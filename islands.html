<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø²Ø± ÙˆØ§Ù„Ù‚Ù„Ø§Ø¹</title>
  <style>
    .castle-number-display {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 5px 0 10px 0;
      padding: 5px;
      background-color: #f0f0f0;
      border-radius: 5px;
      text-align: center;
    }
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #1e6091;
      min-height: 100vh;
      width: 100%;
      height: 100vh;
    }
    .game-container {
      width: 100%;
      position: relative;
      padding: 20px;
      box-sizing: border-box;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }
    .title {
      width: 100%;
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }
    .user-info {
      width: 100%;
      text-align: center;
      font-size: 24px;
      color: white;
      margin-bottom: 20px;
    }
    .user-name {
      font-weight: bold;
      background-color: rgba(255, 255, 255, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      display: inline-block;
    }
    .islands-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      max-width: 100%;
    }
    .island {
      width: 150px;
      height: 150px;
      position: relative;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .island:hover {
      transform: scale(1.05);
    }
    .island-base {
      width: 100%;
      height: 100%;
      background-color: #64A0D7;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    .island-grass {
      position: absolute;
      width: 80%;
      height: 80%;
      left: 10%;
      top: 10%;
      background-color: #8B4513;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    .sand {
      position: absolute;
      border-radius: 45% 50% 40% 48%;
      width: 92%;
      height: 92%;
      left: 4%;
      top: 4%;
      background-color: #D2B48C;
      box-shadow: inset 0 0 10px rgba(101, 67, 33, 0.5);
    }
    .greenery {
      position: absolute;
      width: 70%;
      height: 70%;
      left: 15%;
      top: 15%;
      background-color: #228B22;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
    }
    .terrain {
      position: absolute;
      background-color: rgba(34, 139, 34, 0.5);
      border-radius: 50%;
    }
    .rock {
      position: absolute;
      background-color: #696969;
      border-radius: 35% 45% 30% 40%;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }
    .island-number {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 40%;
      transform: translateY(-50%);
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    .island-info {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 60%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    .island-border {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      border-radius: 50%;
      border: 4px solid transparent;
      box-sizing: border-box;
      pointer-events: none;
    }
    
    /* ØªÙ…ÙˆØ¬Ø§Øª Ø§Ù„Ù…Ø§Ø¡ Ø­ÙˆÙ„ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© */
    .water-ripple {
      position: absolute;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-sizing: border-box;
    }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ­Ø±Ùƒ */
    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(1.2); opacity: 0; }
    }

    .detailed-view {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #1e6091;
      z-index: 100;
      overflow: hidden;
    }
    .detailed-island {
      position: relative;
      width: 80%;
      height: 80vh;
      margin: 40px auto;
      background-color: #64A0D7;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }
    .detailed-grass {
      position: absolute;
      width: 90%;
      height: 90%;
      left: 5%;
      top: 5%;
      background-color: #8B4513;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.3);
    }
    .detailed-sand {
      position: absolute;
      width: 92%;
      height: 92%;
      left: 4%;
      top: 4%;
      background-color: #D2B48C;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(101, 67, 33, 0.5);
    }
    .detailed-greenery {
      position: absolute;
      width: 75%;
      height: 75%;
      left: 12.5%;
      top: 12.5%;
      background-color: #228B22;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
    }
    .detailed-terrain {
      position: absolute;
      background-color: rgba(34, 139, 34, 0.7);
      border-radius: 50%;
    }
    .detailed-rock {
      position: absolute;
      background-color: #696969;
      border-radius: 35% 45% 30% 40%;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    .castle {
      position: absolute;
      width: 40px;
      height: 60px;
      background-color: #888;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s;
      z-index: 10;
    }
    .castle:hover {
      transform: scale(1.1);
    }
    .castle::before {
      content: "";
      position: absolute;
      top: -10px;
      left: 0;
      width: 100%;
      height: 10px;
      background-color: #888;
      border-radius: 5px 5px 0 0;
    }
    .castle::after {
      content: "";
      position: absolute;
      top: -10px;
      left: 8px;
      width: 8px;
      height: 20px;
      background-color: #777;
      border-radius: 5px 5px 0 0;
      box-shadow: 16px 0 0 #777;
    }

    .castle-door {
      position: absolute;
      bottom: 0;
      left: 15px;
      width: 10px;
      height: 20px;
      background-color: #4b2504;
      border-radius: 5px 5px 0 0;
    }
    .castle-border {
      position: absolute;
      width: 60px;
      height: 80px;
      top: -10px;
      left: -10px;
      border-radius: 12px;
      border: 3px solid transparent;
      pointer-events: none;
      box-sizing: border-box;
    }
    .castle-number {
      position: absolute;
      width: 100%;
      text-align: center;
      top: -25px;
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 1);
    }
    .castle-rating {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 0 3px rgba(0, 0, 0, 1);
      background-color: rgba(0, 0, 0, 0.5);
      padding: 2px 0;
    }
    
    /* Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¹Ø¬Ø¨ ÙÙˆÙ‚ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙˆØ§Ù„Ø¬Ø²Ø± Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ÙˆÙ‚Øª */
    .alert-icon {
      position: absolute;
      width: 20px;
      height: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      border-radius: 50%;
      line-height: 20px;
      z-index: 12;
      animation: pulse 1.5s infinite;
    }
    
    /* Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¹Ø¬Ø¨ ÙÙˆÙ‚ Ø§Ù„Ù‚Ù„Ø§Ø¹ */
    .castle .alert-icon {
      left: 50%;
      top: -35px;
      transform: translateX(-50%);
    }
    
    /* Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¹Ø¬Ø¨ ÙÙˆÙ‚ Ø§Ù„Ø¬Ø²Ø± */
    .island .alert-icon {
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 24px;
      top: -15px;
    }
    
    .island .alert-icon.alert-yellow {
      right: 25px;
    }
    
    .island .alert-icon.alert-red {
      left: 25px;
    }
    
    .alert-yellow {
      background-color: #FFCC00;
      color: black;
      box-shadow: 0 0 5px rgba(255, 204, 0, 0.8);
    }
    .alert-red {
      background-color: #FF0000;
      color: white;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.8);
    }
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.2); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    /* ØªØ¹Ø¯ÙŠÙ„ Ù†Ø¨Ø¶ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¹Ø¬Ø¨ ÙÙŠ Ø§Ù„Ø¬Ø²Ø± */
    @keyframes pulse-island {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .island .alert-icon {
      animation: pulse-island 1.5s infinite;
    }
    
    .back-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      z-index: 101;
    }
    .back-button:hover {
      background-color: #45a049;
    }

    .user-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #3F51B5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      z-index: 101;
    }
    .user-button:hover {
      background-color: #303F9F;
    }

    .island-title {
      position: fixed;
      top: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 30px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 101;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 200;
      text-align: center;
      min-width: 300px;
    }
    .modal-content {
      margin-bottom: 20px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 199;
    }
    input[type="range"] {
      width: 90%;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .cancel-button {
      background-color: #f44336;
      margin-right: 10px;
    }
    .cancel-button:hover {
      background-color: #d32f2f;
    }
    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .score-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    .rating-time {
      font-size: 14px;
      color: #555;
      margin: 5px 0;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… */
    .global-stats {
      width: 100%;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 15px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      font-size: 18px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
    }
    .stats-content {
      display: inline-block;
      padding: 5px 20px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }
    .stat-rating {
      font-weight: bold;
      color: yellow;
      margin: 0 5px;
    }
    .stat-alert {
      display: inline-flex;
      align-items: center;
      margin: 0 10px;
    }
    .stat-alert-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-right: 5px;
      font-size: 12px;
    }
    
    /* Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
    .close-button {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 25px;
      height: 25px;
      background-color: #f44336;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .close-button:hover {
      background-color: #d32f2f;
    }
    
    /* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 28px;
      height: 28px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      cursor: pointer;
      margin-right: 5px;
      vertical-align: middle;
    }
    .settings-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .settings-icon {
      width: 18px;
      height: 18px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>');
      background-size: contain;
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-modal {
      width: 350px;
    }
    .settings-item {
      margin: 15px 0;
      text-align: right;
    }
    .settings-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .settings-item input {
      width: 60px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .settings-item span {
      margin-right: 5px;
    }

    /* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    .switch-user-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      z-index: 101;
      display: flex;
      align-items: center;
    }
    .switch-user-button:hover {
      background-color: #F57C00;
    }
    .switch-user-icon {
      margin-left: 5px;
      font-size: 18px;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù†Ø§ÙØ°Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
    .save-indicator {
      position: fixed;
      top: 70px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 101;
      display: none;
      align-items: center;
    }
    .save-icon {
      margin-left: 5px;
      font-size: 16px;
      animation: spin 1s linear infinite;
    }
    .save-success {
      color: #4CAF50;
    }
    .save-error {
      color: #f44336;
    }
  </style>
  <!-- Ù…ÙƒØªØ¨Ø§Øª Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div class="game-container">
    <div class="title">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø²Ø± ÙˆØ§Ù„Ù‚Ù„Ø§Ø¹</div>
    <div class="user-info">
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span class="user-name" id="current-user">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
    <div class="islands-container" id="islandsContainer">
      <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø²Ø± Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JavaScript -->
    </div>
  </div>
  
  <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… -->
  <div class="global-stats" id="globalStats">
    <div class="stats-content">
      ØªÙ… ØªÙ‚ÙŠÙŠÙ…: <span class="stat-rating" id="totalRatedCastles">0</span> Ù…Ù† Ø£ØµÙ„
      <span class="stat-rating" id="totalCastles">0</span> Ù‚Ù„Ø¹Ø© |
      Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…: <span class="stat-rating" id="globalRatingAverage">0%</span> |
      <span class="stat-alert">
        Ù…Ø§ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©: <span class="stat-rating" id="yellowAlertCount">0</span>
        <span class="stat-alert-icon alert-yellow">!</span>
      </span> |
      <span class="stat-alert">
        Ù…Ø§ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø©: <span class="stat-rating" id="redAlertCount">0</span>
        <span class="stat-alert-icon alert-red">!</span>
      </span>
      <div class="settings-button" id="settingsButton">
        <div class="settings-icon"></div>
      </div>
    </div>
  </div>

  <div class="detailed-view" id="detailedView">
    <button class="back-button" id="backButton">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
    <button class="switch-user-button" id="switchUserButton">
      ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      <span class="switch-user-icon">ğŸ‘¥</span>
    </button>
    <div class="island-title" id="islandTitle">Ø§Ù„Ø¬Ø²ÙŠØ±Ø© 1</div>
    <div class="detailed-island">
      <div class="detailed-grass" id="detailedGrass">
        <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù‡Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… JavaScript -->
      </div>
    </div>
    
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø© -->
    <div class="global-stats" id="islandStats">
      <div class="stats-content">
        ØªÙ… ØªÙ‚ÙŠÙŠÙ…: <span class="stat-rating" id="islandRatedCastles">0</span> Ù…Ù† Ø£ØµÙ„
        <span class="stat-rating" id="islandCastles">0</span> Ù‚Ù„Ø¹Ø© |
        Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: <span class="stat-rating" id="islandRatingAverage">0%</span> |
        <span class="stat-alert">
          Ù…Ø§ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©: <span class="stat-rating" id="islandYellowAlertCount">0</span>
          <span class="stat-alert-icon alert-yellow">!</span>
        </span> |
        <span class="stat-alert">
          Ù…Ø§ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø©: <span class="stat-rating" id="islandRedAlertCount">0</span>
          <span class="stat-alert-icon alert-red">!</span>
        </span>
      </div>
    </div>
  </div>

  <div class="modal" id="ratingModal">
    <div class="close-button" id="closeRating">Ã—</div>
    <div class="modal-content">
      <h2>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ù„Ø¹Ø©</h2>
      <div class="castle-number-display" id="castleNumberDisplay"></div>
      <div class="score-display" id="scoreDisplay">50%</div>
      <div class="rating-time" id="ratingTime"></div>
      <input type="range" id="ratingSlider" min="0" max="100" value="50">
      <div class="button-container">
        <button id="cancelRating" class="cancel-button">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        <button id="submitRating">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>
  
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="modal settings-modal" id="settingsModal">
    <div class="close-button" id="closeSettings">Ã—</div>
    <div class="modal-content">
      <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
      
      <div class="settings-item">
        <label>Ù…Ø¯Ø© Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© <span class="stat-alert-icon alert-yellow">!</span></label>
        <input type="number" id="yellowAlertMinutes" min="1" value="5"> <span>Ø¯Ù‚Ø§Ø¦Ù‚</span>
      </div>
      
      <div class="settings-item">
        <label>Ù…Ø¯Ø© Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© <span class="stat-alert-icon alert-red">!</span></label>
        <input type="number" id="redAlertMinutes" min="1" value="10"> <span>Ø¯Ù‚Ø§Ø¦Ù‚</span>
      </div>
      
      <div class="button-container">
        <button id="saveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </div>
  </div>
  
  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ -->
  <div class="save-indicator" id="saveIndicator">
    <span id="saveMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>
    <span class="save-icon" id="saveIcon">âŸ³</span>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <script>
    // ØªÙƒÙˆÙŠÙ† Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDuGoFrbrN73z-JiiFsfTBydg28Lft4EUk",
    authDomain: "island-74dec.firebaseapp.com",
    databaseURL: "https://island-74dec-default-rtdb.firebaseio.com", // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    projectId: "island-74dec",
    storageBucket: "island-74dec.firebasestorage.app",
    messagingSenderId: "220206860551",
    appId: "1:220206860551:web:8bcd14754e0427fa89dda2",
    measurementId: "G-QGYV54JB2J"
  };
  
  // ØªÙ‡ÙŠØ¦Ø© Firebase
  firebase.initializeApp(firebaseConfig);
  
  // Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const database = firebase.database();
  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  const numberOfIslands = 30;
  // Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„ÙƒÙ„ Ø¬Ø²ÙŠØ±Ø© (21 Ù„Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ 20 Ù„Ù„Ø¨Ø§Ù‚ÙŠØŒ 23 Ù„Ù„Ø¬Ø²ÙŠØ±Ø© 30)
  function getCastlesCount(islandId) {
    if (islandId === 0) {
      return 21; // Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„ÙÙ‡Ø±Ø³ 0) Ù„Ù‡Ø§ 21 Ù‚Ù„Ø¹Ø©
    } else if (islandId === 29) {
      return 23; // Ø§Ù„Ø¬Ø²ÙŠØ±Ø© 30 (Ø§Ù„ÙÙ‡Ø±Ø³ 29) Ù„Ù‡Ø§ 23 Ù‚Ù„Ø¹Ø©
    } else {
      return 20; // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø²Ø± Ù„Ù‡Ø§ 20 Ù‚Ù„Ø¹Ø©
    }
  }
  
  // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const islandsContainer = document.getElementById('islandsContainer');
  const detailedView = document.getElementById('detailedView');
  const detailedGrass = document.getElementById('detailedGrass');
  const backButton = document.getElementById('backButton');
  const islandTitle = document.getElementById('islandTitle');
  const ratingModal = document.getElementById('ratingModal');
  const overlay = document.getElementById('overlay');
  const ratingSlider = document.getElementById('ratingSlider');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const submitButton = document.getElementById('submitRating');
  const cancelButton = document.getElementById('cancelRating');
  const closeRatingButton = document.getElementById('closeRating');
  const ratingTimeElement = document.getElementById('ratingTime');
  const castleNumberDisplayElement = document.getElementById('castleNumberDisplay');
  const switchUserButton = document.getElementById('switchUserButton');
  const saveIndicator = document.getElementById('saveIndicator');
  const saveMessage = document.getElementById('saveMessage');
  const saveIcon = document.getElementById('saveIcon');
  
  // Ø¹Ù†Ø§ØµØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…
  const totalRatedCastlesElement = document.getElementById('totalRatedCastles');
  const totalCastlesElement = document.getElementById('totalCastles');
  const globalRatingAverageElement = document.getElementById('globalRatingAverage');
  const yellowAlertCountElement = document.getElementById('yellowAlertCount');
  const redAlertCountElement = document.getElementById('redAlertCount');
  
  // Ø¹Ù†Ø§ØµØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
  const islandStatsElement = document.getElementById('islandStats');
  const islandRatedCastlesElement = document.getElementById('islandRatedCastles');
  const islandCastlesElement = document.getElementById('islandCastles');
  const islandRatingAverageElement = document.getElementById('islandRatingAverage');
  const islandYellowAlertCountElement = document.getElementById('islandYellowAlertCount');
  const islandRedAlertCountElement = document.getElementById('islandRedAlertCount');
  
  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const settingsButton = document.getElementById('settingsButton');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettingsButton = document.getElementById('closeSettings');
  const yellowAlertMinutesInput = document.getElementById('yellowAlertMinutes');
  const redAlertMinutesInput = document.getElementById('redAlertMinutes');
  const saveSettingsButton = document.getElementById('saveSettings');
  
  let currentIsland = null;
  let selectedCastle = null;
  let alertCheckInterval = null; // ÙØ§ØµÙ„ Ø²Ù…Ù†ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  
  // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø¯Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)
  let yellowAlertMinutes = 5;  // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£ØµÙØ±
  let redAlertMinutes = 10;    // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø­Ù…Ø±
  
  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  let currentUser = localStorage.getItem('selectedUser') || 'mohammed';
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  document.getElementById('current-user').textContent = currentUser === 'mohammed' ? 'Ù…Ø­Ù…Ø¯' : 'Ø³Ø¹Ø¯';
  
  // Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³
  const terrainColors = [
    'rgba(34, 139, 34, 0.7)',
    'rgba(34, 139, 34, 0.5)',
    'rgba(85, 107, 47, 0.6)',
    'rgba(107, 142, 35, 0.5)',
    'rgba(154, 205, 50, 0.4)'
  ];
  
  // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø°ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„Ø¬Ø²Ø± Ù„Ø¶Ù…Ø§Ù† Ø«Ø¨Ø§ØªÙ‡Ø§
  const islandSeeds = [];
  for (let i = 0; i < numberOfIslands; i++) {
    islandSeeds.push(Math.random());
  }
  
  // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„ÙƒÙ„ Ø¬Ø²ÙŠØ±Ø©
  let islandsData = [];
  
  // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø²Ø±
  let islandAverageRatings = [];
  
  // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø«Ø§Ø¨Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø°Ø±Ø© Ø«Ø§Ø¨ØªØ©
  function pseudoRandom(seed, index) {
    return (Math.sin(seed * 9999 + index * 999) * 10000) % 1;
  }
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
  function formatDate(timestamp) {
    if (!timestamp) return 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¹Ø¯';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) {
      return 'Ø§Ù„Ø¢Ù†';
    } else if (diffMins < 60) {
      return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    } else if (diffHours < 24) {
      return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
    } else if (diffDays < 30) {
      return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
    } else {
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
  }
  
  // ÙˆØ¸ÙŠÙØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Firebase
  async function saveGameData() {
    // ÙÙŠ ÙˆØ¸ÙŠÙØ© saveGameDataØŒ Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø·Ø± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙˆØ¸ÙŠÙØ©
    console.log("Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
    console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:", currentUser);
    
    // Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ FirebaseØŒ Ø£Ø¶Ù
    console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firebase");
    
    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø£Ø¶Ù
    console.error("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:", error);
    
    // ÙÙŠ ÙˆØ¸ÙŠÙØ© switchUserØŒ Ø£Ø¶Ù
    console.log("Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù†", currentUser);
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸
    saveIndicator.style.display = 'flex';
    saveMessage.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    saveIcon.className = 'save-icon';
    
    try {
      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const gameData = {
        islandsData: islandsData,
        islandAverageRatings: islandAverageRatings,
        settings: {
          yellowAlertMinutes: yellowAlertMinutes,
          redAlertMinutes: redAlertMinutes
        },
        lastUpdated: new Date().toISOString()
      };
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      localStorage.setItem(`islandsCastlesGame_${currentUser}`, JSON.stringify(gameData));
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
      await database.ref(`users/${currentUser}`).set(gameData);
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
      saveMessage.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!';
      saveIcon.className = 'save-icon save-success';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 2000);
      
      return true;
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„ÙØ´Ù„
      saveMessage.textContent = 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª! ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§';
      saveIcon.className = 'save-icon save-error';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 3000);
      
      return false;
    }
  }
    
  // ÙˆØ¸ÙŠÙØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
  async function loadGameData() {
    try {
      console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser} Ù…Ù† Firebase`);
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
      const snapshot = await database.ref(`users/${currentUser}`).once('value');
      const onlineData = snapshot.val();
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
      const savedData = localStorage.getItem(`islandsCastlesGame_${currentUser}`);
      let localData = null;
      
      if (savedData) {
        localData = JSON.parse(savedData);
        console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser} Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ`);
      }
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
      if (onlineData) {
        console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser} Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­`);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
        if (localData && localData.lastUpdated && 
            new Date(localData.lastUpdated) > new Date(onlineData.lastUpdated)) {
          console.log(`Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£Ø­Ø¯Ø«ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Firebase`);
          
          islandsData = localData.islandsData;
          islandAverageRatings = localData.islandAverageRatings;
          
          if (localData.settings) {
            yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
            redAlertMinutes = localData.settings.redAlertMinutes || 10;
            yellowAlertMinutesInput.value = yellowAlertMinutes;
            redAlertMinutesInput.value = redAlertMinutes;
          }
          
          // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ø£Ø­Ø¯Ø« Ù…Ø¹ Firebase
          database.ref(`users/${currentUser}`).set(localData);
        } else {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
          islandsData = onlineData.islandsData;
          islandAverageRatings = onlineData.islandAverageRatings;
          
          if (onlineData.settings) {
            yellowAlertMinutes = onlineData.settings.yellowAlertMinutes || 5;
            redAlertMinutes = onlineData.settings.redAlertMinutes || 10;
            yellowAlertMinutesInput.value = yellowAlertMinutes;
            redAlertMinutesInput.value = redAlertMinutes;
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
          localStorage.setItem(`islandsCastlesGame_${currentUser}`, JSON.stringify(onlineData));
        }
        
        return true;
      } 
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„ÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
      else if (localData) {
        console.log(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©`);
        
        islandsData = localData.islandsData;
        islandAverageRatings = localData.islandAverageRatings;
        
        if (localData.settings) {
          yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
          redAlertMinutes = localData.settings.redAlertMinutes || 10;
          yellowAlertMinutesInput.value = yellowAlertMinutes;
          redAlertMinutesInput.value = redAlertMinutes;
        }
        
        // Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Firebase
        database.ref(`users/${currentUser}`).set(localData);
        
        return true;
      }
      
      // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©
      console.log(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser}`);
      return false;
    } catch (error) {
      console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${currentUser}:`, error);
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
      const savedData = localStorage.getItem(`islandsCastlesGame_${currentUser}`);
      if (savedData) {
        console.log(`Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø³Ø¨Ø¨ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase`);
        const localData = JSON.parse(savedData);
        
        islandsData = localData.islandsData;
        islandAverageRatings = localData.islandAverageRatings;
        
        if (localData.settings) {
          yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
          redAlertMinutes = localData.settings.redAlertMinutes || 10;
          yellowAlertMinutesInput.value = yellowAlertMinutes;
          redAlertMinutesInput.value = redAlertMinutes;
        }
        
        return true;
      }
      
      return false;
    }
  }
    
  // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
  function initializeGameData() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    const dataLoaded = loadGameData();
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    if (!dataLoaded) {
      for (let i = 0; i < numberOfIslands; i++) {
        const castlesCount = getCastlesCount(i);
        console.log(`ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ${i+1} Ø¨Ø¹Ø¯Ø¯ Ù‚Ù„Ø§Ø¹: ${castlesCount}`);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ù„Ø§Ø¹ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
        islandsData[i] = [];
        for (let j = 0; j < castlesCount; j++) {
          islandsData[i][j] = {
            rating: 0,
            evaluated: false,
            lastRated: null // ÙˆÙ‚Øª Ø¢Ø®Ø± ØªÙ‚ÙŠÙŠÙ…
          };
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        islandAverageRatings[i] = {
          average: 0,
          evaluated: 0
        };
      }
    } 
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø§ØµÙŠØ© lastRated ÙˆØ¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„ÙƒÙ„ Ø¬Ø²ÙŠØ±Ø©
    else {
      for (let i = 0; i < numberOfIslands; i++) {
        const castlesCount = getCastlesCount(i);
        console.log(`ÙØ­Øµ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ${i+1} Ø¨Ø¹Ø¯Ø¯ Ù‚Ù„Ø§Ø¹: ${castlesCount}, Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯: ${islandsData[i]?.length || 0}`);
        
        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
        if (!islandsData[i]) {
          islandsData[i] = [];
        }
        
        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù‚Ù„Ø§Ø¹
        if (islandsData[i].length !== castlesCount) {
          console.log(`ØªØµØ­ÙŠØ­ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„Ù„Ø¬Ø²ÙŠØ±Ø© ${i+1}: Ù…Ù† ${islandsData[i].length} Ø¥Ù„Ù‰ ${castlesCount}`);
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ù„Ø§Ø¹ Ø£ÙƒØ«Ø±ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
          while (islandsData[i].length > castlesCount) {
            islandsData[i].pop();
          }
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ù„Ø§Ø¹ Ø£Ù‚Ù„ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          while (islandsData[i].length < castlesCount) {
            islandsData[i].push({
              rating: 0,
              evaluated: false,
              lastRated: null
            });
          }
        }
        
        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®Ø§ØµÙŠØ© lastRated Ù„ÙƒÙ„ Ù‚Ù„Ø¹Ø©
        for (let j = 0; j < castlesCount; j++) {
          if (!islandsData[i][j]) {
            islandsData[i][j] = {
              rating: 0,
              evaluated: false,
              lastRated: null
            };
          } else if (islandsData[i][j].lastRated === undefined) {
            islandsData[i][j].lastRated = null;
          }
        }
        
        // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        if (!islandAverageRatings[i]) {
          islandAverageRatings[i] = {
            average: 0,
            evaluated: 0
          };
        }
      }
    }
  }
</script>

<script>
  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  function countAlertCastles() {
    let yellowCount = 0;
    let redCount = 0;
    const now = Date.now();
    
    for (let i = 0; i < numberOfIslands; i++) {
      const castlesCount = getCastlesCount(i);
      
      for (let j = 0; j < castlesCount; j++) {
        const castleData = islandsData[i][j];
        if (!castleData.evaluated || !castleData.lastRated) continue;
        
        const lastRated = new Date(castleData.lastRated).getTime();
        const timeDiff = (now - lastRated) / (1000 * 60); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        
        if (timeDiff >= redAlertMinutes) {
          redCount++;
        } else if (timeDiff >= yellowAlertMinutes) {
          yellowCount++;
        }
      }
    }
    
    return { yellowCount, redCount };
  }
  
  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙŠ Ø¬Ø²ÙŠØ±Ø© Ù…Ø­Ø¯Ø¯Ø©
  function countIslandAlertCastles(islandId) {
    let yellowCount = 0;
    let redCount = 0;
    const now = Date.now();
    const castlesCount = getCastlesCount(islandId);
    
    for (let j = 0; j < castlesCount; j++) {
      const castleData = islandsData[islandId][j];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
      
      if (timeDiff >= redAlertMinutes) {
        redCount++;
      } else if (timeDiff >= yellowAlertMinutes) {
        yellowCount++;
      }
    }
    
    return { yellowCount, redCount };
  }

  // ÙØ­Øµ Ø­Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹
  function checkRatingAlerts() {
    if (currentIsland === null) return;
    
    const castlesCount = getCastlesCount(currentIsland);
    const now = Date.now();
    
    for (let i = 0; i < castlesCount; i++) {
      const castleData = islandsData[currentIsland][i];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
      
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†Ø¨ÙŠÙ‡ Ù…ÙˆØ¬ÙˆØ¯Ø©
      const castle = document.querySelector(`.castle[data-castle-id="${i}"]`);
      if (!castle) continue;
      
      const existingAlert = castle.querySelector('.alert-icon');
      if (existingAlert) {
        castle.removeChild(existingAlert);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
      if (timeDiff >= redAlertMinutes) { // Ù…Ø± ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©
        addAlertIcon(castle, 'red');
      } else if (timeDiff >= yellowAlertMinutes) { // Ù…Ø± ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        addAlertIcon(castle, 'yellow');
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    updateIslandStats();
  }
  
  // ØªØ­Ø¯ÙŠØ« ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø²Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  function updateIslandAlerts() {
    // Ù…Ø³Ø­ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    document.querySelectorAll('.island .alert-icon').forEach(alert => {
      alert.remove();
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø¬Ø²ÙŠØ±Ø©
    for (let i = 0; i < numberOfIslands; i++) {
      const island = document.querySelector(`.island[data-island-id="${i}"]`);
      if (!island) continue;
      
      const alertStatus = checkIslandAlertStatus(i);
      
      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      if (alertStatus.hasRed) {
        addIslandAlertIcon(island, 'red');
      }
      
      if (alertStatus.hasYellow) {
        addIslandAlertIcon(island, 'yellow');
      }
    }
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
  function checkIslandAlertStatus(islandId) {
    let hasYellow = false;
    let hasRed = false;
    const castlesCount = getCastlesCount(islandId);
    const now = Date.now();
    
    for (let j = 0; j < castlesCount; j++) {
      const castleData = islandsData[islandId][j];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
      
      if (timeDiff >= redAlertMinutes) {
        hasRed = true;
      } else if (timeDiff >= yellowAlertMinutes) {
        hasYellow = true;
      }
      
      // Ù„Ù„ØªØ­Ø³ÙŠÙ†: Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ÙƒÙ„Ø§ Ø§Ù„Ù†ÙˆØ¹ÙŠÙ† Ù…Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ù†ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¨Ø­Ø«
      if (hasRed && hasYellow) break;
    }
    
    return { hasYellow, hasRed };
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
  function addAlertIcon(castle, color) {
    const alertIcon = document.createElement('div');
    alertIcon.className = `alert-icon alert-${color}`;
    alertIcon.textContent = '!';
    castle.appendChild(alertIcon);
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
  function addIslandAlertIcon(island, color) {
    const alertIcon = document.createElement('div');
    alertIcon.className = `alert-icon alert-${color}`;
    alertIcon.textContent = '!';
    island.appendChild(alertIcon);
  }
  
  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø©
  function updateGlobalStats() {
    let totalCastles = 0;
    let totalRatedCastles = 0;
    let totalRatingsSum = 0;
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…ÙÙ‚ÙŠÙ…Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…
    for (let i = 0; i < numberOfIslands; i++) {
      const castlesCount = getCastlesCount(i);
      totalCastles += castlesCount;
      
      if (islandAverageRatings[i]) {
        totalRatedCastles += islandAverageRatings[i].evaluated;
        totalRatingsSum += islandAverageRatings[i].average * islandAverageRatings[i].evaluated;
      }
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…
    const globalAverage = totalRatedCastles > 0 ? totalRatingsSum / totalRatedCastles : 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    totalCastlesElement.textContent = totalCastles;
    totalRatedCastlesElement.textContent = totalRatedCastles;
    globalRatingAverageElement.textContent = globalAverage.toFixed(1) + '%';
    
    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…
    globalRatingAverageElement.style.color = getRatingColor(globalAverage);
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    const alertCounts = countAlertCastles();
    yellowAlertCountElement.textContent = alertCounts.yellowCount;
    redAlertCountElement.textContent = alertCounts.redCount;
    
    // ØªØ­Ø¯ÙŠØ« ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø²Ø±
    updateIslandAlerts();
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  function updateIslandStats() {
    if (currentIsland === null) return;
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù‚Ù„Ø§Ø¹
    const castlesCount = getCastlesCount(currentIsland);
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…Ù‚ÙŠÙ…Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¯Ù‚Ø©
    let evaluated = 0;
    let totalRatings = 0;
    
    // ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù‚Ù„Ø§Ø¹
    if (!islandsData[currentIsland] || islandsData[currentIsland].length !== castlesCount) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§
      if (!islandsData[currentIsland]) {
        islandsData[currentIsland] = [];
      }
      
      // Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù‚Ù„Ø§Ø¹
      while (islandsData[currentIsland].length < castlesCount) {
        islandsData[currentIsland].push({
          rating: 0,
          evaluated: false,
          lastRated: null
        });
      }
      
      while (islandsData[currentIsland].length > castlesCount) {
        islandsData[currentIsland].pop();
      }
    }
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…Ù‚ÙŠÙ…Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·
    for (let i = 0; i < castlesCount; i++) {
      if (islandsData[currentIsland][i].evaluated) {
        evaluated++;
        totalRatings += islandsData[currentIsland][i].rating;
      }
    }
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·
    const average = evaluated > 0 ? totalRatings / evaluated : 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    if (!islandAverageRatings[currentIsland]) {
      islandAverageRatings[currentIsland] = { average: 0, evaluated: 0 };
    }
    
    islandAverageRatings[currentIsland].average = average;
    islandAverageRatings[currentIsland].evaluated = evaluated;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    islandCastlesElement.textContent = castlesCount;
    islandRatedCastlesElement.textContent = evaluated;
    islandRatingAverageElement.textContent = average.toFixed(1) + '%';
    islandRatingAverageElement.style.color = getRatingColor(average);
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    const alertCounts = countIslandAlertCastles(currentIsland);
    islandYellowAlertCountElement.textContent = alertCounts.yellowCount;
    islandRedAlertCountElement.textContent = alertCounts.redCount;
    
    console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ${currentIsland + 1}: Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${castlesCount}ØŒ Ø§Ù„Ù…Ù‚ÙŠÙ…Ø©: ${evaluated}ØŒ Ø§Ù„Ù…ØªÙˆØ³Ø·: ${average.toFixed(1)}%`);
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    saveGameData();
  }
  
  // ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ù„Ù‰ Ù„ÙˆÙ† Ø¨ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£Ø­Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø®Ø¶Ø±
  function getRatingColor(rating) {
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    if (rating >= 95) {
      return '#00FF00'; // Ø£Ø®Ø¶Ø± Ø³Ø§Ø·Ø¹ Ø¹Ù†Ø¯ 100%
    } else if (rating >= 75) {
      // ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„ÙØ§ØªØ­ Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙØ± Ù…Ù† 95% Ø¥Ù„Ù‰ 75%
      const green = 255;
      const red = 255 - Math.floor((rating - 75) * (255 / 20));
      return `rgb(${red}, ${green}, 0)`;
    } else if (rating >= 50) {
      // ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø£ØµÙØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ù† 75% Ø¥Ù„Ù‰ 50%
      const green = Math.floor((rating - 50) * (255 / 25));
      return `rgb(255, ${green}, 0)`;
    } else {
      // ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø± Ù…Ù† 50% Ø¥Ù„Ù‰ 0%
      const red = 255;
      const green = Math.floor(rating * 2.55);
      return `rgb(${red}, ${green}, 0)`;
    }
  }
  
  // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ ÙˆÙ…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
  function distributeCastlesEvenly(containerWidth, containerHeight, numberOfCastles, castleWidth, castleHeight, islandId) {
    const containerRadius = Math.min(containerWidth, containerHeight) / 2;
    // ØªÙ‚Ù„ÙŠÙ„ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ©
    const safeRadius = containerRadius * 0.95;
    const castlePositions = [];
    const minDistance = Math.max(castleWidth, castleHeight) * 1.0; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¯Ù†ÙŠØ§ Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù„Ø§Ø¹
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ Ø¯ÙˆØ§Ø¦Ø± Ù…ØªØ­Ø¯Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ù…Ø¹ ØªØ¨Ø§Ø¹Ø¯Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…ØªØ³Ø§ÙˆÙ
    const rings = 7; // Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù„Ù‚Ø§Øª
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù†Ø§Ø³Ø¨Ø©
    const maxAttempts = 100;
    
    // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„ØªÙŠ ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
    let placedCastles = 0;
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ ÙƒÙ„ Ø­Ù„Ù‚Ø©
    for (let ring = 0; ring < rings && placedCastles < numberOfCastles; ring++) {
      // Ø­Ø³Ø§Ø¨ Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø­Ù„Ù‚Ø© Ù…Ø¹ ØªØ±Ùƒ Ù…Ø³Ø§ÙØ© ÙƒØ§ÙÙŠØ© Ù…Ù† Ø§Ù„Ø­Ø§ÙØ©
      const radiusMin = safeRadius * (0.15 + (ring * 0.85 / rings));
      const radiusMax = safeRadius * (0.15 + ((ring + 0.8) * 0.85 / rings));

      // Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø© ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ù…Ø­ÙŠØ·Ù‡Ø§
      const ringRatio = (ring + 1) / rings;
      const castlesInRing = Math.min(
        Math.ceil(numberOfCastles * ringRatio * 0.7),
        numberOfCastles - placedCastles
      );
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù„Ù‚Ø©
      for (let i = 0; i < castlesInRing; i++) {
        let validPosition = false;
        let attempts = 0;
        let x, y;
        
        while (!validPosition && attempts < maxAttempts) {
          attempts++;
          
          // Ø²Ø§ÙˆÙŠØ© Ù…ØªØ¨Ø§Ø¹Ø¯Ø© Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
          const baseAngle = (i / castlesInRing) * 2 * Math.PI;
          const angle = baseAngle + pseudoRandom(islandSeeds[islandId], 100 + ring * 30 + i) * 0.3;
          
          // Ù†ØµÙ Ù‚Ø·Ø± Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          const radius = radiusMin + pseudoRandom(islandSeeds[islandId], 200 + ring * 30 + i) * (radiusMax - radiusMin);
          
          // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ù„Ø¹Ø©
          x = containerWidth/2 + radius * Math.cos(angle) - castleWidth/2;
          y = containerHeight/2 + radius * Math.sin(angle) - castleHeight/2;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ù„Ø¹Ø© Ù…Ø¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰
          validPosition = true;
          for (const pos of castlePositions) {
            const dx = pos.x - x;
            const dy = pos.y - y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < minDistance) {
              validPosition = false;
              break;
            }
          }
        }
        
        if (validPosition) {
          castlePositions.push({ x, y });
          placedCastles++;
        }
      }
    }

    // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙ…ÙƒÙ† Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ù…Ù† ÙˆØ¶Ø¹ ÙƒÙ„ Ø§Ù„Ù‚Ù„Ø§Ø¹ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ù‚Ù„ ØªÙ‚ÙŠÙŠØ¯Ù‹Ø§
    if (placedCastles < numberOfCastles) {
      const remainingCastles = numberOfCastles - placedCastles;
      
      for (let i = 0; i < remainingCastles; i++) {
        let validPosition = false;
        let attempts = 0;
        let x, y;
        
        while (!validPosition && attempts < maxAttempts) {
          attempts++;
          
          // Ù…ÙˆÙ‚Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¶Ù…Ù† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
          const radius = pseudoRandom(islandSeeds[islandId], 500 + i) * safeRadius;
          const angle = pseudoRandom(islandSeeds[islandId], 600 + i) * 2 * Math.PI;
          
          x = containerWidth/2 + radius * Math.cos(angle) - castleWidth/2;
          y = containerHeight/2 + radius * Math.sin(angle) - castleHeight/2;
          
          // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ù…Ø³Ø§ÙØ© Ø£Ù‚Ù„
          validPosition = true;
          for (const pos of castlePositions) {
            const dx = pos.x - x;
            const dy = pos.y - y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < minDistance * 0.8) { // ØªØ®ÙÙŠØ¶ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù‚Ù„Ø§Ø¹ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
              validPosition = false;
              break;
            }
          }
        }
        
        if (validPosition) {
          castlePositions.push({ x, y });
        }
      }
    }
    
    return castlePositions;
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„
  function showDetailedIsland(islandId) {
    currentIsland = islandId;
    islandTitle.textContent = `Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ${islandId + 1}`;
    detailedView.style.display = 'block';
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙˆØ§Ù„ØªØ¶Ø§Ø±ÙŠØ³ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    while (detailedGrass.firstChild) {
      detailedGrass.removeChild(detailedGrass.firstChild);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø±Ù…Ù„
    const detailedSand = document.createElement('div');
    detailedSand.className = 'detailed-sand';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ù†ÙØ³Ù‡ Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const randomShape = `${45 + pseudoRandom(islandSeeds[islandId], 1) * 10}% ${50 + pseudoRandom(islandSeeds[islandId], 2) * 10}% ${40 + pseudoRandom(islandSeeds[islandId], 3) * 10}% ${48 + pseudoRandom(islandSeeds[islandId], 4) * 10}%`;
    detailedSand.style.borderRadius = randomShape;
    detailedGrass.style.borderRadius = randomShape;
    
    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø¶Ø±Ø©
    const detailedGreenery = document.createElement('div');
    detailedGreenery.className = 'detailed-greenery';
    detailedGreenery.style.borderRadius = randomShape;
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const hue = 100 + Math.floor(pseudoRandom(islandSeeds[islandId], 9) * 40);
    detailedGreenery.style.backgroundColor = `hsl(${hue}, ${60 + pseudoRandom(islandSeeds[islandId], 10) * 20}%, ${30 + pseudoRandom(islandSeeds[islandId], 11) * 15}%)`;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ¶Ø§Ø±ÙŠØ³
    for (let t = 0; t < 12; t++) {
      const terrain = document.createElement('div');
      terrain.className = 'detailed-terrain';
      terrain.style.width = Math.floor(15 + pseudoRandom(islandSeeds[islandId], 20 + t * 3) * 40) + '%';
      terrain.style.height = Math.floor(15 + pseudoRandom(islandSeeds[islandId], 21 + t * 3) * 40) + '%';
      terrain.style.left = Math.floor(pseudoRandom(islandSeeds[islandId], 22 + t * 3) * 80) + '%';
      terrain.style.top = Math.floor(pseudoRandom(islandSeeds[islandId], 23 + t * 3) * 80) + '%';
      terrain.style.backgroundColor = terrainColors[Math.floor(pseudoRandom(islandSeeds[islandId], 24 + t) * terrainColors.length)];
      terrain.style.borderRadius = `${30 + pseudoRandom(islandSeeds[islandId], 25 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 26 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 27 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 28 + t * 3) * 20}%`;
      detailedGreenery.appendChild(terrain);
    }
    
    // Ø¥Ø¶Ø§ÙØ© ØµØ®ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    for (let r = 0; r < 6; r++) {
      const rock = document.createElement('div');
      rock.className = 'detailed-rock';
      rock.style.width = Math.floor(3 + pseudoRandom(islandSeeds[islandId], 50 + r * 3) * 8) + '%';
      rock.style.height = Math.floor(3 + pseudoRandom(islandSeeds[islandId], 51 + r * 3) * 8) + '%';
      rock.style.left = Math.floor(pseudoRandom(islandSeeds[islandId], 52 + r * 3) * 90) + '%';
      rock.style.top = Math.floor(pseudoRandom(islandSeeds[islandId], 53 + r * 3) * 90) + '%';
      rock.style.borderRadius = `${30 + pseudoRandom(islandSeeds[islandId], 54 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 55 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 56 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 57 + r * 3) * 20}%`;
      detailedSand.appendChild(rock);
    }
    
    detailedSand.appendChild(detailedGreenery);
    detailedGrass.appendChild(detailedSand);
    
    // Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    const castlesCount = getCastlesCount(islandId);
    console.log(`Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ${islandId+1} Ø¨Ø¹Ø¯Ø¯ Ù‚Ù„Ø§Ø¹: ${castlesCount}`);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    const containerWidth = detailedGrass.offsetWidth || 800;
    const containerHeight = detailedGrass.offsetHeight || 600;
    const castleWidth = 40;
    const castleHeight = 60;
    
    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø­Ø§Ø¡ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    const castlePositions = distributeCastlesEvenly(
      containerWidth, 
      containerHeight, 
      castlesCount, 
      castleWidth, 
      castleHeight,
      islandId
    );
    
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù„Ø§Ø¹
    while (islandsData[islandId].length < castlesCount) {
      islandsData[islandId].push({
        rating: 0,
        evaluated: false,
        lastRated: null
      });
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø¨Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­
    for (let i = 0; i < castlesCount; i++) {
      const pos = castlePositions[i];
      
      const castle = document.createElement('div');
      castle.className = 'castle';
      castle.dataset.castleId = i;
      castle.style.left = pos.x + 'px';
      castle.style.top = pos.y + 'px';
      
      // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¨ Ù„Ù„Ù‚Ù„Ø¹Ø©
      const door = document.createElement('div');
      door.className = 'castle-door';
      castle.appendChild(door);
      
      // Ø¥Ø¶Ø§ÙØ© Ø¥Ø·Ø§Ø± Ù„Ù„Ù‚Ù„Ø¹Ø©
      const border = document.createElement('div');
      border.className = 'castle-border';
      border.id = `castle-border-${i}`;
      castle.appendChild(border);
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ù‚Ù„Ø¹Ø©
      const castleNumber = document.createElement('div');
      castleNumber.className = 'castle-number';
      // Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‚Ù„Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
      let castleGlobalNumber = 1;
      // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù„Ø§Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø²Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      for (let j = 0; j < islandId; j++) {
        castleGlobalNumber += getCastlesCount(j);
      }
      castleGlobalNumber += i;
      castleNumber.textContent = castleGlobalNumber;
      castle.appendChild(castleNumber);
      
      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      const ratingDisplay = document.createElement('div');
      ratingDisplay.className = 'castle-rating';
      ratingDisplay.id = `castle-rating-${i}`;
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
      if (islandsData[currentIsland][i].evaluated) {
        const rating = islandsData[currentIsland][i].rating;
        ratingDisplay.textContent = rating + '%';
        updateCastleBorder(border, rating);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ Ù…Ø¶Ù‰ ÙˆÙ‚Øª Ø·ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        const lastRated = new Date(islandsData[currentIsland][i].lastRated).getTime();
        const now = Date.now();
        const timeDiff = (now - lastRated) / (1000 * 60); // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        
        if (timeDiff >= redAlertMinutes) { // Ù…Ø± ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©
          addAlertIcon(castle, 'red');
        } else if (timeDiff >= yellowAlertMinutes) { // Ù…Ø± ÙˆÙ‚Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
          addAlertIcon(castle, 'yellow');
        }
      } else {
        ratingDisplay.textContent = 'Ù„Ù… ÙŠÙÙ‚ÙŠÙ‘Ù…';
      }
      
      castle.appendChild(ratingDisplay);
      
      // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
      castle.addEventListener('click', function() {
        selectedCastle = this;
        const castleId = parseInt(this.dataset.castleId);
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
        const currentRating = islandsData[currentIsland][castleId].evaluated 
          ? islandsData[currentIsland][castleId].rating 
          : 50;
        
        ratingSlider.value = currentRating;
        scoreDisplay.textContent = currentRating + '%';

        // Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù‚Ù„Ø¹Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        castleNumberDisplayElement.textContent = `Ø§Ù„Ù‚Ù„Ø¹Ø© Ø±Ù‚Ù…: ${parseInt(castle.querySelector('.castle-number').textContent)}`;
        
        // Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø¢Ø®Ø± ØªÙ‚ÙŠÙŠÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if (islandsData[currentIsland][castleId].lastRated) {
          ratingTimeElement.textContent = `Ø¢Ø®Ø± ØªÙ‚ÙŠÙŠÙ…: ${formatDate(islandsData[currentIsland][castleId].lastRated)}`;
        } else {
          ratingTimeElement.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¹Ø¯';
        }
        
        ratingModal.style.display = 'block';
        overlay.style.display = 'block';
      });
      
      detailedGrass.appendChild(castle);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    setTimeout(updateIslandStats, 100);  // ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    
    // Ø¨Ø¯Ø¡ ÙØ­Øµ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    if (alertCheckInterval) {
      clearInterval(alertCheckInterval);
    }
    alertCheckInterval = setInterval(checkRatingAlerts, 60000);
    
    // ÙØ­Øµ ÙÙˆØ±ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    checkRatingAlerts();
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  function updateCastleBorder(borderElement, rating) {
    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    borderElement.style.borderColor = getRatingColor(rating);
  }
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø© ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  function updateIslandInfo() {
    for (let i = 0; i < numberOfIslands; i++) {
      const infoElement = document.getElementById(`island-info-${i}`);
      const borderElement = document.getElementById(`island-border-${i}`);
      
      const totalCastles = getCastlesCount(i);
      const evaluated = islandAverageRatings[i].evaluated;
      const average = islandAverageRatings[i].average;
      
      infoElement.textContent = `${evaluated}/${totalCastles} (${average.toFixed(1)}%)`;
      
      // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø¥Ø°Ø§ ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø£ÙŠ Ù‚Ù„Ø¹Ø©
      if (evaluated > 0) {
        borderElement.style.borderColor = getRatingColor(average);
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø© Ø£ÙŠØ¶Ù‹Ø§
    updateGlobalStats();
  }
  
   // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  async function switchUser() {
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    await saveGameData();
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    currentUser = currentUser === 'mohammed' ? 'saad' : 'mohammed';
    
    // ØªØ­Ø¯ÙŠØ« localStorage
    localStorage.setItem('selectedUser', currentUser);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.location.reload();
  }
    
  // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù„Ø§Ø¹
  function enhanceCastleDisplay() {
    const castleElements = document.querySelectorAll('.castle');
    
    castleElements.forEach((castle, index) => {
      // ØªÙ†ÙˆÙŠØ¹ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù‚Ù„Ø§Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø°Ø±Ø© Ø«Ø§Ø¨ØªØ©
      const islandId = currentIsland;
      const castleId = parseInt(castle.dataset.castleId);
      
      const baseHue = 10 + Math.floor(pseudoRandom(islandSeeds[islandId], 300 + castleId * 3) * 40);
      const baseSaturation = 10 + Math.floor(pseudoRandom(islandSeeds[islandId], 301 + castleId * 3) * 20);
      const baseLightness = 40 + Math.floor(pseudoRandom(islandSeeds[islandId], 302 + castleId * 3) * 30);
      
      castle.style.backgroundColor = `hsl(${baseHue}, ${baseSaturation}%, ${baseLightness}%)`;
      
      // ØªØ­Ø³ÙŠÙ† Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ù‚Ù„Ø§Ø¹
      const door = castle.querySelector('.castle-door');
      if (door) {
        door.style.backgroundColor = `hsl(${baseHue}, ${baseSaturation + 20}%, ${baseLightness - 20}%)`;
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø¨Ø¶ Ù„Ù„Ø¨Ø§Ø¨
        const doorHandle = document.createElement('div');
        doorHandle.style.position = 'absolute';
        doorHandle.style.width = '2px';
        doorHandle.style.height = '2px';
        doorHandle.style.backgroundColor = '#FFD700';
        doorHandle.style.borderRadius = '50%';
        doorHandle.style.top = '10px';
        doorHandle.style.right = '2px';
        door.appendChild(doorHandle);
      }
      
      // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ù†ÙˆØ§ÙØ° Ø§Ù„Ù‚Ù„Ø¹Ø©
      const windowCount = Math.floor(pseudoRandom(islandSeeds[islandId], 400 + castleId) * 3) + 1;
      for (let i = 0; i < windowCount; i++) {
        const castleWindow = document.createElement('div');
        castleWindow.style.position = 'absolute';
        castleWindow.style.width = '6px';
        castleWindow.style.height = '8px';
        castleWindow.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        castleWindow.style.borderRadius = '2px';
        castleWindow.style.top = `${15 + i * 15}px`;
        castleWindow.style.left = `${10 + pseudoRandom(islandSeeds[islandId], 401 + castleId + i) * 20}px`;
        castle.appendChild(castleWindow);
      }
    });
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø²Ø±
  for (let i = 0; i < numberOfIslands; i++) {
    const island = document.createElement('div');
    island.className = 'island';
    island.dataset.islandId = i;
    
    const islandBase = document.createElement('div');
    islandBase.className = 'island-base';
    
    // Ø¥Ø¶Ø§ÙØ© ØªÙ…ÙˆØ¬Ø§Øª Ø§Ù„Ù…Ø§Ø¡
    for (let r = 0; r < 3; r++) {
      const ripple = document.createElement('div');
      ripple.className = 'water-ripple';
      ripple.style.width = (100 + r * 10) + '%';
      ripple.style.height = (100 + r * 10) + '%';
      ripple.style.top = (-5 * r) + '%';
      ripple.style.left = (-5 * r) + '%';
      ripple.style.animation = `ripple ${2 + r * 0.5}s infinite alternate-reverse ease-in-out`;
      islandBase.appendChild(ripple);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø°Ø±Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
    const grass = document.createElement('div');
    grass.className = 'island-grass';
    
    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø±Ù…Ù„
    const sand = document.createElement('div');
    sand.className = 'sand';
    
    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø¶Ø±Ø©
    const greenery = document.createElement('div');
    greenery.className = 'greenery';
    
    // Ø¥Ø¶Ø§ÙØ© ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ÙˆÙ„ÙƒÙ† Ø«Ø§Ø¨ØªØ© Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    const randomShape = `${45 + pseudoRandom(islandSeeds[i], 1) * 10}% ${50 + pseudoRandom(islandSeeds[i], 2) * 10}% ${40 + pseudoRandom(islandSeeds[i], 3) * 10}% ${48 + pseudoRandom(islandSeeds[i], 4) * 10}%`;
    grass.style.borderRadius = randomShape;
    sand.style.borderRadius = randomShape;
    greenery.style.borderRadius = randomShape;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¸Ù„Ø§Ù„ ÙˆØªØ£Ø«ÙŠØ±Ø§Øª Ø¹Ù…Ù‚ Ø¥Ø¶Ø§ÙÙŠØ©
    grass.style.boxShadow = `inset 0 0 ${10 + Math.floor(pseudoRandom(islandSeeds[i], 5) * 15)}px rgba(0, 0, 0, ${0.3 + pseudoRandom(islandSeeds[i], 6) * 0.2})`;
    sand.style.boxShadow = `inset 0 0 ${5 + Math.floor(pseudoRandom(islandSeeds[i], 7) * 10)}px rgba(101, 67, 33, ${0.4 + pseudoRandom(islandSeeds[i], 8) * 0.2})`;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ¯Ø±Ø¬Ø§Øª Ù„ÙˆÙ†ÙŠØ© Ù„Ù„Ø¬Ø²ÙŠØ±Ø©
    const hue = 100 + Math.floor(pseudoRandom(islandSeeds[i], 9) * 40); // ØªÙ†ÙˆØ¹ ÙÙŠ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø±
    greenery.style.backgroundColor = `hsl(${hue}, ${60 + pseudoRandom(islandSeeds[i], 10) * 20}%, ${30 + pseudoRandom(islandSeeds[i], 11) * 15}%)`;
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ¶Ø§Ø±ÙŠØ³ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© (Ù…Ù†Ø§Ø·Ù‚ Ø®Ø¶Ø±Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ© Ø§Ù„Ø¸Ù„Ø§Ù„)
    for (let t = 0; t < 7; t++) {
      const terrain = document.createElement('div');
      terrain.className = 'terrain';
      terrain.style.width = Math.floor(15 + pseudoRandom(islandSeeds[i], 20 + t * 3) * 30) + '%';
      terrain.style.height = Math.floor(15 + pseudoRandom(islandSeeds[i], 21 + t * 3) * 30) + '%';
      terrain.style.left = Math.floor(pseudoRandom(islandSeeds[i], 22 + t * 3) * 70) + '%';
      terrain.style.top = Math.floor(pseudoRandom(islandSeeds[i], 23 + t * 3) * 70) + '%';
      terrain.style.backgroundColor = terrainColors[Math.floor(pseudoRandom(islandSeeds[i], 24 + t) * terrainColors.length)];
      greenery.appendChild(terrain);
    }
    
    // Ø¥Ø¶Ø§ÙØ© ØµØ®ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    for (let r = 0; r < 3; r++) {
      const rock = document.createElement('div');
      rock.className = 'rock';
      rock.style.width = Math.floor(5 + pseudoRandom(islandSeeds[i], 50 + r * 3) * 10) + '%';
      rock.style.height = Math.floor(5 + pseudoRandom(islandSeeds[i], 51 + r * 3) * 10) + '%';
      rock.style.left = Math.floor(pseudoRandom(islandSeeds[i], 52 + r * 3) * 90) + '%';
      rock.style.top = Math.floor(pseudoRandom(islandSeeds[i], 53 + r * 3) * 90) + '%';
      sand.appendChild(rock);
    }
    
    const number = document.createElement('div');
    number.className = 'island-number';
    number.textContent = (i + 1);
    
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
    const info = document.createElement('div');
    info.className = 'island-info';
    info.id = `island-info-${i}`;
    
    const evaluated = islandAverageRatings[i]?.evaluated || 0;
    const average = islandAverageRatings[i]?.average || 0;
    const totalCastles = getCastlesCount(i);
    info.textContent = `${evaluated}/${totalCastles} (${average.toFixed(1)}%)`;
    
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ù„Ù„Ø¥Ø·Ø§Ø±
    const border = document.createElement('div');
    border.className = 'island-border';
    border.id = `island-border-${i}`;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªÙ‚ÙŠÙŠÙ…Ø§Øª
    if (evaluated > 0) {
      border.style.borderColor = getRatingColor(average);
    }
    
    grass.appendChild(sand);
    sand.appendChild(greenery);
    islandBase.appendChild(grass);
    island.appendChild(islandBase);
    island.appendChild(number);
    island.appendChild(info);
    island.appendChild(border);
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
    island.addEventListener('click', function() {
      showDetailedIsland(i);
    });
    
    islandsContainer.appendChild(island);
  }
  
  // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
  initializeGameData();
  
  // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø©
  updateGlobalStats();
  
  // ØªØºÙŠÙŠØ± Ø¹Ø±Ø¶ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³Ù„ÙŠØ¯Ø±
  ratingSlider.addEventListener('input', function() {
    scoreDisplay.textContent = this.value + '%';
  });
  
  // Ø¥Ù„ØºØ§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ù„Ø¹Ø©
  cancelButton.addEventListener('click', function() {
    if (selectedCastle) {
      const castleId = parseInt(selectedCastle.dataset.castleId);
      const castleData = islandsData[currentIsland][castleId];
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ù„Ø¹Ø© Ù…ÙÙ‚ÙŠÙ…Ø© Ø¨Ø§Ù„ÙØ¹Ù„
      if (castleData.evaluated) {
        const oldRating = castleData.rating;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù„Ø¹Ø©
        castleData.evaluated = false;
        castleData.rating = 0;
        castleData.lastRated = null;
        
        // ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
        const islandData = islandAverageRatings[currentIsland];
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±
        if (islandData.evaluated > 1) {
          islandData.average = ((islandData.average * islandData.evaluated) - oldRating) / (islandData.evaluated - 1);
        } else {
          islandData.average = 0;
        }
        
        islandData.evaluated--;
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù„Ø¹Ø©
        const borderElement = document.getElementById(`castle-border-${castleId}`);
        const ratingElement = document.getElementById(`castle-rating-${castleId}`);
        
        borderElement.style.borderColor = 'transparent';
        ratingElement.textContent = 'Ù„Ù… ÙŠÙÙ‚ÙŠÙ‘Ù…';
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†Ø¨ÙŠÙ‡
        const alertIcon = selectedCastle.querySelector('.alert-icon');
        if (alertIcon) {
          selectedCastle.removeChild(alertIcon);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
        updateIslandStats();
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
        const islandBorderElement = document.getElementById(`island-border-${currentIsland}`);
        if (islandData.evaluated > 0) {
          islandBorderElement.style.borderColor = getRatingColor(islandData.average);
        } else {
          islandBorderElement.style.borderColor = 'transparent';
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveGameData();
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø©
        updateGlobalStats();
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      ratingModal.style.display = 'none';
      overlay.style.display = 'none';
      selectedCastle = null;
    }
  });
  
  // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  closeRatingButton.addEventListener('click', function() {
    ratingModal.style.display = 'none';
    overlay.style.display = 'none';
    selectedCastle = null;
  });

  // ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
  submitButton.addEventListener('click', function() {
    if (selectedCastle) {
      const castleId = parseInt(selectedCastle.dataset.castleId);
      const rating = parseInt(ratingSlider.value);
      const borderElement = document.getElementById(`castle-border-${castleId}`);
      const ratingElement = document.getElementById(`castle-rating-${castleId}`);
      
      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ù„Ø¹Ø©
      const castleData = islandsData[currentIsland][castleId];
      const oldRating = castleData.rating;
      const wasEvaluated = castleData.evaluated;
      
      castleData.rating = rating;
      castleData.evaluated = true;
      castleData.lastRated = Date.now(); // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ù„Ø¹Ø©
      ratingElement.textContent = rating + '%';
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø·Ø§Ø± Ø§Ù„Ù‚Ù„Ø¹Ø©
      updateCastleBorder(borderElement, rating);
      
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†Ø¨ÙŠÙ‡ Ù…ÙˆØ¬ÙˆØ¯Ø©
      const alertIcon = selectedCastle.querySelector('.alert-icon');
      if (alertIcon) {
        selectedCastle.removeChild(alertIcon);
      }
      
      // ØªØ­Ø¯ÙŠØ« Ù…ØªÙˆØ³Ø· ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
      const islandData = islandAverageRatings[currentIsland];
      
      if (!wasEvaluated) {
        // Ø£ÙˆÙ„ ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ù‚Ù„Ø¹Ø©
        islandData.evaluated++;
        islandData.average = ((islandData.average * (islandData.evaluated - 1)) + rating) / islandData.evaluated;
      } else {
        // ØªØ¹Ø¯ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø³Ø§Ø¨Ù‚
        islandData.average = ((islandData.average * islandData.evaluated) - oldRating + rating) / islandData.evaluated;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø²ÙŠØ±Ø©
      updateIslandStats();
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø²ÙŠØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const islandBorderElement = document.getElementById(`island-border-${currentIsland}`);
      islandBorderElement.style.borderColor = getRatingColor(islandData.average);
      
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      saveGameData();
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø©
      updateGlobalStats();
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      ratingModal.style.display = 'none';
      overlay.style.display = 'none';
      selectedCastle = null;
    }
  });
  
  // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
  backButton.addEventListener('click', function() {
    detailedView.style.display = 'none';
    currentIsland = null;
    
    // Ø¥ÙŠÙ‚Ø§Ù ÙØ§ØµÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    if (alertCheckInterval) {
      clearInterval(alertCheckInterval);
      alertCheckInterval = null;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø²Ø± ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    updateIslandInfo();
  });
  
  // Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  switchUserButton.addEventListener('click', function() {
    switchUser();
  });
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  settingsButton.addEventListener('click', function() {
    // Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    yellowAlertMinutesInput.value = yellowAlertMinutes;
    redAlertMinutesInput.value = redAlertMinutes;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    settingsModal.style.display = 'block';
    overlay.style.display = 'block';
  });
  
  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  closeSettingsButton.addEventListener('click', function() {
    settingsModal.style.display = 'none';
    overlay.style.display = 'none';
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  saveSettingsButton.addEventListener('click', function() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠÙ…
    const yellowMinutes = parseInt(yellowAlertMinutesInput.value);
    const redMinutes = parseInt(redAlertMinutesInput.value);
    
    if (yellowMinutes > 0 && redMinutes > 0 && redMinutes > yellowMinutes) {
      yellowAlertMinutes = yellowMinutes;
      redAlertMinutes = redMinutes;
      
      // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      saveGameData();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
      updateGlobalStats();
      if (currentIsland !== null) {
        checkRatingAlerts();
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      settingsModal.style.display = 'none';
      overlay.style.display = 'none';
    } else {
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚ÙŠÙ… ØºÙŠØ± ØµØ­ÙŠØ­Ø©
      alert('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¬Ù„Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆÙƒÙ„Ø§Ù‡Ù…Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
    }
  });
  
  // ØªÙ†ÙÙŠØ° ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø¬Ø²ÙŠØ±Ø© ØªÙØµÙŠÙ„ÙŠØ©
  window.addEventListener('load', function() {
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    updateGlobalStats();
    
    // ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØµÙ„ ÙÙ‚Ø·
    document.addEventListener('click', function() {
      if (currentIsland !== null) {
        setTimeout(enhanceCastleDisplay, 100);
      }
    });
  });
</script>
