<script>
  // تنسيق التاريخ بطريقة سهلة القراءة
  function formatDate(timestamp) {
    if (!timestamp) return 'لم يتم التقييم بعد';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) {
      return 'الآن';
    } else if (diffMins < 60) {
      return `منذ ${diffMins} دقيقة`;
    } else if (diffHours < 24) {
      return `منذ ${diffHours} ساعة`;
    } else if (diffDays < 30) {
      return `منذ ${diffDays} يوم`;
    } else {
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
  }
  
  // التحقق ما إذا كان التاريخان في نفس اليوم
  function isSameDay(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
  }
  
  // التحقق ما إذا كان التاريخان في أيام متتالية
  function isConsecutiveDay(prevDate, currDate) {
    const d1 = new Date(prevDate);
    const d2 = new Date(currDate);
    
    // إضافة يوم واحد إلى التاريخ السابق
    d1.setDate(d1.getDate() + 1);
    
    return d1.getFullYear() === d2.getFullYear() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getDate() === d2.getDate();
  }
  
  // حساب الفرق بالأيام بين تاريخين
  function getDaysDifference(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    // إزالة معلومات الوقت وضبط التواريخ على منتصف الليل
    d1.setHours(0, 0, 0, 0);
    d2.setHours(0, 0, 0, 0);
    
    // حساب الفرق بالمللي ثانية وتحويله إلى أيام
    const diffTime = Math.abs(d2 - d1);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  }
  
  // وظيفة لحفظ البيانات على Firebase (نسخة مبسطة وآمنة)
  async function saveGameData() {
    console.log("محاولة حفظ البيانات...");
    // إظهار مؤشر الحفظ
    saveIndicator.style.display = 'flex';
    saveMessage.textContent = 'جاري الحفظ...';
    saveIcon.className = 'save-icon';
    
    try {
      // تجميع البيانات
      const gameData = {
        islandsData: islandsData,
        islandAverageRatings: islandAverageRatings,
        settings: {
          yellowAlertDays: yellowAlertDays,
          redAlertDays: redAlertDays,
          dailyReviewCount: dailyReviewCount,
          newCastlePeriod: newCastlePeriod
        },
        stats: {
          dailyReviewStreak: dailyReviewStreak,
          newCastleStreak: newCastleStreak,
          lastReviewDate: lastReviewDate,
          reviewsCompletedToday: reviewsCompletedToday,
          lastNewCastleDate: lastNewCastleDate
        },
        lastUpdated: new Date().toISOString()
      };
      
      // حفظ البيانات محليًا أولاً
      localStorage.setItem(`islandsCastlesGame_${currentUser}`, JSON.stringify(gameData));
      console.log("تم الحفظ محليًا");
      
      // محاولة حفظ البيانات في Firebase 
      const dbRef = firebase.database().ref();
      console.log("جاري الحفظ في Firebase...");
      await dbRef.child(`users/${currentUser}`).set(gameData);
      console.log("تم الحفظ في Firebase بنجاح");
      
      // تحديث مؤشر الحفظ بعد النجاح
      saveMessage.textContent = 'تم الحفظ بنجاح!';
      saveIcon.className = 'save-icon save-success';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 2000);
      
      return true;
    } catch (err) {
      console.error('خطأ في حفظ البيانات:', err);
      
      // تحديث مؤشر الحفظ بعد الفشل
      saveMessage.textContent = 'فشل الحفظ عبر الإنترنت! تم الحفظ محليًا فقط';
      saveIcon.className = 'save-icon save-error';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 3000);
      
      return false;
    }
  }
  
  // تبديل المستخدم (نسخة محسنة)
  async function switchUser() {
    try {
      console.log(`بدء تبديل المستخدم من ${currentUser}`);
      
      // انتقال إلى الصفحة الرئيسية
      window.location.href = "https://alomairmo.github.io/island";
      return true;
    } catch (err) {
      console.error("خطأ في تبديل المستخدم:", err);
      return false;
    }
  }
  
  // زر التحديث
  function refreshIslands() {
    // عرض مؤشر التحميل
    saveIndicator.style.display = 'flex';
    saveMessage.textContent = 'جاري التحديث...';
    saveIcon.className = 'save-icon';
    
    // محاولة إعادة تحميل البيانات من السيرفر
    loadGameData().then(() => {
      // تحديث معلومات الجزر في الشاشة الرئيسية
      updateIslandInfo();
      
      // تحديث إحصائيات التقييم العامة
      updateGlobalStats();
      
      // إظهار رسالة النجاح
      saveMessage.textContent = 'تم التحديث بنجاح!';
      saveIcon.className = 'save-icon save-success';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 2000);
    }).catch(err => {
      console.error('خطأ أثناء التحديث:', err);
      
      // إظهار رسالة الخطأ
      saveMessage.textContent = 'فشل التحديث! جاري استخدام البيانات المحلية';
      saveIcon.className = 'save-icon save-error';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 3000);
    });
  }
  
  // إعداد أحداث أزرار واجهة المستخدم
  document.addEventListener('DOMContentLoaded', function() {
    // تهيئة اللعبة
    initializeGameData();
    
    // زر العودة للخريطة
    backButton.addEventListener('click', function() {
      detailedView.style.display = 'none';
      currentIsland = null;
      
      // إيقاف فاصل التحقق من التنبيهات
      if (alertCheckInterval) {
        clearInterval(alertCheckInterval);
        alertCheckInterval = null;
      }
      
      // تحديث معلومات الجزر في الشاشة الرئيسية
      updateIslandInfo();
    });
    
    // زر تبديل المستخدم
    switchUserButton.addEventListener('click', switchUser);
    
    // زر تبديل المستخدم في الصفحة الرئيسية
    const switchUserButtonMain = document.getElementById('switchUserButtonMain');
    if (switchUserButtonMain) {
      switchUserButtonMain.addEventListener('click', switchUser);
    }
    
    // زر التحديث في الصفحة الرئيسية
    const refreshButton = document.getElementById('refreshButton');
    if (refreshButton) {
      refreshButton.addEventListener('click', refreshIslands);
    }
    
    // زر العودة للصفحة الرئيسية
    const homeButton = document.getElementById('homeButton');
    if (homeButton) {
      homeButton.addEventListener('click', function() {
        // إظهار مؤشر التحميل أو رسالة
        saveIndicator.style.display = 'flex';
        saveMessage.textContent = 'جاري حفظ البيانات قبل العودة...';
        saveIcon.className = 'save-icon';
        
        // حفظ البيانات تلقائياً قبل العودة
        saveGameData().then(() => {
          console.log('تم حفظ البيانات بنجاح قبل العودة للصفحة الرئيسية');
          // الانتقال إلى الصفحة الرئيسية بعد تأخير قصير
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000); // تأخير 1 ثانية لإظهار رسالة النجاح
        }).catch(err => {
          console.error('فشل في حفظ البيانات:', err);
          saveMessage.textContent = 'فشل الحفظ. جاري العودة...';
          saveIcon.className = 'save-icon save-error';
          
          // العودة حتى في حالة فشل الحفظ بعد تأخير قصير
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1500);
        });
      });
    }
  });
</script>
