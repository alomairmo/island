<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لعبة الجزر والقلاع</title>
  <style>
    .castle-number-display {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 5px 0 10px 0;
      padding: 5px;
      background-color: #f0f0f0;
      border-radius: 5px;
      text-align: center;
    }
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: #1e6091;
      min-height: 100vh;
      width: 100%;
      height: 100vh;
    }
    .game-container {
      width: 100%;
      position: relative;
      padding: 20px;
      box-sizing: border-box;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }
    .title {
      width: 100%;
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
    }
    .user-info {
      width: 100%;
      text-align: center;
      font-size: 24px;
      color: white;
      margin-bottom: 20px;
    }
    .user-name {
      font-weight: bold;
      background-color: rgba(255, 255, 255, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      display: inline-block;
    }
    .islands-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      max-width: 100%;
    }
    .island {
      width: 150px;
      height: 150px;
      position: relative;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .island:hover {
      transform: scale(1.05);
    }
    .island-base {
      width: 100%;
      height: 100%;
      background-color: #64A0D7;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    .island-grass {
      position: absolute;
      width: 80%;
      height: 80%;
      left: 10%;
      top: 10%;
      background-color: #8B4513;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    .sand {
      position: absolute;
      border-radius: 45% 50% 40% 48%;
      width: 92%;
      height: 92%;
      left: 4%;
      top: 4%;
      background-color: #D2B48C;
      box-shadow: inset 0 0 10px rgba(101, 67, 33, 0.5);
    }
    .greenery {
      position: absolute;
      width: 70%;
      height: 70%;
      left: 15%;
      top: 15%;
      background-color: #228B22;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
    }
    .terrain {
      position: absolute;
      background-color: rgba(34, 139, 34, 0.5);
      border-radius: 50%;
    }
    .rock {
      position: absolute;
      background-color: #696969;
      border-radius: 35% 45% 30% 40%;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }
    .island-number {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 40%;
      transform: translateY(-50%);
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    .island-info {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 60%;
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
      z-index: 10;
    }
    .island-border {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      border-radius: 50%;
      border: 4px solid transparent;
      box-sizing: border-box;
      pointer-events: none;
    }
    
    /* تموجات الماء حول الجزيرة */
    .water-ripple {
      position: absolute;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-sizing: border-box;
    }

    /* تأثير الماء المتحرك */
    @keyframes ripple {
      0% { transform: scale(1); opacity: 0.5; }
      100% { transform: scale(1.2); opacity: 0; }
    }

    .detailed-view {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #1e6091;
      z-index: 100;
      overflow: hidden;
    }
    .detailed-island {
      position: relative;
      width: 80%;
      height: 80vh;
      margin: 40px auto;
      background-color: #64A0D7;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }
    .detailed-grass {
      position: absolute;
      width: 90%;
      height: 90%;
      left: 5%;
      top: 5%;
      background-color: #8B4513;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.3);
    }
    .detailed-sand {
      position: absolute;
      width: 92%;
      height: 92%;
      left: 4%;
      top: 4%;
      background-color: #D2B48C;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(101, 67, 33, 0.5);
    }
    .detailed-greenery {
      position: absolute;
      width: 75%;
      height: 75%;
      left: 12.5%;
      top: 12.5%;
      background-color: #228B22;
      border-radius: 45% 50% 40% 48%;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
    }
    .detailed-terrain {
      position: absolute;
      background-color: rgba(34, 139, 34, 0.7);
      border-radius: 50%;
    }
    .detailed-rock {
      position: absolute;
      background-color: #696969;
      border-radius: 35% 45% 30% 40%;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }
    .castle {
      position: absolute;
      width: 40px;
      height: 60px;
      background-color: #888;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
      transition: transform 0.2s;
      z-index: 10;
    }
    .castle:hover {
      transform: scale(1.1);
    }
    .castle::before {
      content: "";
      position: absolute;
      top: -10px;
      left: 0;
      width: 100%;
      height: 10px;
      background-color: #888;
      border-radius: 5px 5px 0 0;
    }
    .castle::after {
      content: "";
      position: absolute;
      top: -10px;
      left: 8px;
      width: 8px;
      height: 20px;
      background-color: #777;
      border-radius: 5px 5px 0 0;
      box-shadow: 16px 0 0 #777;
    }

    .castle-door {
      position: absolute;
      bottom: 0;
      left: 15px;
      width: 10px;
      height: 20px;
      background-color: #4b2504;
      border-radius: 5px 5px 0 0;
    }
    .castle-border {
      position: absolute;
      width: 60px;
      height: 80px;
      top: -10px;
      left: -10px;
      border-radius: 12px;
      border: 3px solid transparent;
      pointer-events: none;
      box-sizing: border-box;
    }
    .castle-number {
      position: absolute;
      width: 100%;
      text-align: center;
      top: -25px;
      color: white;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 1);
    }
    .castle-rating {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 0 3px rgba(0, 0, 0, 1);
      background-color: rgba(0, 0, 0, 0.5);
      padding: 2px 0;
    }
    
    /* علامات التعجب فوق القلاع والجزر لتنبيه الوقت */
    .alert-icon {
      position: absolute;
      width: 20px;
      height: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      border-radius: 50%;
      line-height: 20px;
      z-index: 12;
      animation: pulse 1.5s infinite;
    }
    
    /* علامات التعجب فوق القلاع */
    .castle .alert-icon {
      left: 50%;
      top: -35px;
      transform: translateX(-50%);
    }
    
    /* علامات التعجب فوق الجزر */
    .island .alert-icon {
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 24px;
      top: -15px;
    }
    
    .island .alert-icon.alert-yellow {
      right: 25px;
    }
    
    .island .alert-icon.alert-red {
      left: 25px;
    }
    
    .alert-yellow {
      background-color: #FFCC00;
      color: black;
      box-shadow: 0 0 5px rgba(255, 204, 0, 0.8);
    }
    .alert-red {
      background-color: #FF0000;
      color: white;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.8);
    }
    @keyframes pulse {
      0% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.2); }
      100% { transform: translateX(-50%) scale(1); }
    }
    
    /* تعديل نبض علامات التعجب في الجزر */
    @keyframes pulse-island {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .island .alert-icon {
      animation: pulse-island 1.5s infinite;
    }
    
    .back-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      z-index: 101;
    }
    .back-button:hover {
      background-color: #45a049;
    }

    .user-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #3F51B5;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 18px;
      z-index: 101;
    }
    .user-button:hover {
      background-color: #303F9F;
    }

    .island-title {
      position: fixed;
      top: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 30px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      z-index: 101;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 200;
      text-align: center;
      min-width: 300px;
    }
    .modal-content {
      margin-bottom: 20px;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 199;
    }
    input[type="range"] {
      width: 90%;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .cancel-button {
      background-color: #f44336;
      margin-right: 10px;
    }
    .cancel-button:hover {
      background-color: #d32f2f;
    }
    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .score-display {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    .rating-time {
      font-size: 14px;
      color: #555;
      margin: 5px 0;
    }

    /* تنسيق عداد التقييم العام */
    .global-stats {
      width: 100%;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 15px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      font-size: 18px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
    }
    .stats-content {
      display: inline-block;
      padding: 5px 20px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }
    .stat-rating {
      font-weight: bold;
      color: yellow;
      margin: 0 5px;
    }
    .stat-alert {
      display: inline-flex;
      align-items: center;
      margin: 0 10px;
    }
    .stat-alert-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-right: 5px;
      font-size: 12px;
    }
    
    /* زر إغلاق نافذة التقييم */
    .close-button {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 25px;
      height: 25px;
      background-color: #f44336;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .close-button:hover {
      background-color: #d32f2f;
    }
    
    /* زر الإعدادات */
    .settings-button {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 28px;
      height: 28px;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      cursor: pointer;
      margin-right: 5px;
      vertical-align: middle;
    }
    .settings-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .settings-icon {
      width: 18px;
      height: 18px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>');
      background-size: contain;
    }
    
    /* نافذة الإعدادات */
    .settings-modal {
      width: 350px;
    }
    .settings-item {
      margin: 15px 0;
      text-align: right;
    }
    .settings-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .settings-item input {
      width: 60px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .settings-item span {
      margin-right: 5px;
    }

    /* زر تبديل المستخدم */
    .switch-user-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      z-index: 101;
      display: flex;
      align-items: center;
    }
    .switch-user-button:hover {
      background-color: #F57C00;
    }
    .switch-user-icon {
      margin-left: 5px;
      font-size: 18px;
    }

    /* أنماط نافذة حفظ البيانات */
    .save-indicator {
      position: fixed;
      top: 70px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 101;
      display: none;
      align-items: center;
    }
    .save-icon {
      margin-left: 5px;
      font-size: 16px;
      animation: spin 1s linear infinite;
    }
    .save-success {
      color: #4CAF50;
    }
    .save-error {
      color: #f44336;
    }
  </style>
  <!-- مكتبات Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div class="game-container">
    <div class="title">لعبة الجزر والقلاع</div>
    <div class="user-info">
      المستخدم: <span class="user-name" id="current-user">جارٍ التحميل...</span>
    </div>
    <div class="islands-container" id="islandsContainer">
      <!-- سيتم إنشاء الجزر هنا باستخدام JavaScript -->
    </div>
  </div>
  
  <!-- عداد التقييم العام -->
  <div class="global-stats" id="globalStats">
    <div class="stats-content">
      تم تقييم: <span class="stat-rating" id="totalRatedCastles">0</span> من أصل
      <span class="stat-rating" id="totalCastles">0</span> قلعة |
      متوسط التقييم العام: <span class="stat-rating" id="globalRatingAverage">0%</span> |
      <span class="stat-alert">
        ما يحتاج مراجعة: <span class="stat-rating" id="yellowAlertCount">0</span>
        <span class="stat-alert-icon alert-yellow">!</span>
      </span> |
      <span class="stat-alert">
        ما يحتاج مراجعة عاجلة: <span class="stat-rating" id="redAlertCount">0</span>
        <span class="stat-alert-icon alert-red">!</span>
      </span>
      <div class="settings-button" id="settingsButton">
        <div class="settings-icon"></div>
      </div>
    </div>
  </div>

  <div class="detailed-view" id="detailedView">
    <button class="back-button" id="backButton">العودة للخريطة</button>
    <button class="switch-user-button" id="switchUserButton">
      تبديل المستخدم
      <span class="switch-user-icon">👥</span>
    </button>
    <div class="island-title" id="islandTitle">الجزيرة 1</div>
    <div class="detailed-island">
      <div class="detailed-grass" id="detailedGrass">
        <!-- سيتم إنشاء القلاع هنا باستخدام JavaScript -->
      </div>
    </div>
    
    <!-- إحصائيات الجزيرة -->
    <div class="global-stats" id="islandStats">
      <div class="stats-content">
        تم تقييم: <span class="stat-rating" id="islandRatedCastles">0</span> من أصل
        <span class="stat-rating" id="islandCastles">0</span> قلعة |
        متوسط التقييم: <span class="stat-rating" id="islandRatingAverage">0%</span> |
        <span class="stat-alert">
          ما يحتاج مراجعة: <span class="stat-rating" id="islandYellowAlertCount">0</span>
          <span class="stat-alert-icon alert-yellow">!</span>
        </span> |
        <span class="stat-alert">
          ما يحتاج مراجعة عاجلة: <span class="stat-rating" id="islandRedAlertCount">0</span>
          <span class="stat-alert-icon alert-red">!</span>
        </span>
      </div>
    </div>
  </div>

  <div class="modal" id="ratingModal">
    <div class="close-button" id="closeRating">×</div>
    <div class="modal-content">
      <h2>تقييم القلعة</h2>
      <div class="castle-number-display" id="castleNumberDisplay"></div>
      <div class="score-display" id="scoreDisplay">50%</div>
      <div class="rating-time" id="ratingTime"></div>
      <input type="range" id="ratingSlider" min="0" max="100" value="50">
      <div class="button-container">
        <button id="cancelRating" class="cancel-button">إلغاء التقييم</button>
        <button id="submitRating">تأكيد</button>
      </div>
    </div>
  </div>
  
  <!-- نافذة الإعدادات -->
  <div class="modal settings-modal" id="settingsModal">
    <div class="close-button" id="closeSettings">×</div>
    <div class="modal-content">
      <h2>إعدادات التنبيهات</h2>
      
      <div class="settings-item">
        <label>مدة الحاجة للمراجعة <span class="stat-alert-icon alert-yellow">!</span></label>
        <input type="number" id="yellowAlertMinutes" min="1" value="5"> <span>دقائق</span>
      </div>
      
      <div class="settings-item">
        <label>مدة الحاجة للمراجعة العاجلة <span class="stat-alert-icon alert-red">!</span></label>
        <input type="number" id="redAlertMinutes" min="1" value="10"> <span>دقائق</span>
      </div>
      
      <div class="button-container">
        <button id="saveSettings">حفظ الإعدادات</button>
      </div>
    </div>
  </div>
  
  <!-- مؤشر الحفظ -->
  <div class="save-indicator" id="saveIndicator">
    <span id="saveMessage">جاري الحفظ...</span>
    <span class="save-icon" id="saveIcon">⟳</span>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <script>
    // تكوين Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDuGoFrbrN73z-JiiFsfTBydg28Lft4EUk",
    authDomain: "island-74dec.firebaseapp.com",
    databaseURL: "https://island-74dec-default-rtdb.firebaseio.com", // أضف هذا السطر
    projectId: "island-74dec",
    storageBucket: "island-74dec.firebasestorage.app",
    messagingSenderId: "220206860551",
    appId: "1:220206860551:web:8bcd14754e0427fa89dda2",
    measurementId: "G-QGYV54JB2J"
  };
  
  // تهيئة Firebase
  firebase.initializeApp(firebaseConfig);
  
  // مرجع قاعدة البيانات
  const database = firebase.database();
  // المتغيرات العامة
  const numberOfIslands = 30;
  // عدد القلاع لكل جزيرة (21 للجزيرة الأولى، 20 للباقي، 23 للجزيرة 30)
  function getCastlesCount(islandId) {
    if (islandId === 0) {
      return 21; // الجزيرة الأولى (الفهرس 0) لها 21 قلعة
    } else if (islandId === 29) {
      return 23; // الجزيرة 30 (الفهرس 29) لها 23 قلعة
    } else {
      return 20; // باقي الجزر لها 20 قلعة
    }
  }
  
  // تهيئة عناصر واجهة المستخدم
  const islandsContainer = document.getElementById('islandsContainer');
  const detailedView = document.getElementById('detailedView');
  const detailedGrass = document.getElementById('detailedGrass');
  const backButton = document.getElementById('backButton');
  const islandTitle = document.getElementById('islandTitle');
  const ratingModal = document.getElementById('ratingModal');
  const overlay = document.getElementById('overlay');
  const ratingSlider = document.getElementById('ratingSlider');
  const scoreDisplay = document.getElementById('scoreDisplay');
  const submitButton = document.getElementById('submitRating');
  const cancelButton = document.getElementById('cancelRating');
  const closeRatingButton = document.getElementById('closeRating');
  const ratingTimeElement = document.getElementById('ratingTime');
  const castleNumberDisplayElement = document.getElementById('castleNumberDisplay');
  const switchUserButton = document.getElementById('switchUserButton');
  const saveIndicator = document.getElementById('saveIndicator');
  const saveMessage = document.getElementById('saveMessage');
  const saveIcon = document.getElementById('saveIcon');
  
  // عناصر إحصائيات التقييم العام
  const totalRatedCastlesElement = document.getElementById('totalRatedCastles');
  const totalCastlesElement = document.getElementById('totalCastles');
  const globalRatingAverageElement = document.getElementById('globalRatingAverage');
  const yellowAlertCountElement = document.getElementById('yellowAlertCount');
  const redAlertCountElement = document.getElementById('redAlertCount');
  
  // عناصر إحصائيات الجزيرة
  const islandStatsElement = document.getElementById('islandStats');
  const islandRatedCastlesElement = document.getElementById('islandRatedCastles');
  const islandCastlesElement = document.getElementById('islandCastles');
  const islandRatingAverageElement = document.getElementById('islandRatingAverage');
  const islandYellowAlertCountElement = document.getElementById('islandYellowAlertCount');
  const islandRedAlertCountElement = document.getElementById('islandRedAlertCount');
  
  // عناصر الإعدادات
  const settingsButton = document.getElementById('settingsButton');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettingsButton = document.getElementById('closeSettings');
  const yellowAlertMinutesInput = document.getElementById('yellowAlertMinutes');
  const redAlertMinutesInput = document.getElementById('redAlertMinutes');
  const saveSettingsButton = document.getElementById('saveSettings');
  
  let currentIsland = null;
  let selectedCastle = null;
  let alertCheckInterval = null; // فاصل زمني للتحقق من تنبيهات التقييم
  
  // متغيرات مدة التنبيهات (بالدقائق)
  let yellowAlertMinutes = 5;  // المدة الافتراضية للتنبيه الأصفر
  let redAlertMinutes = 10;    // المدة الافتراضية للتنبيه الأحمر
  
  // المستخدم الحالي
  let currentUser = localStorage.getItem('selectedUser') || 'mohammed';
  
  // تحديث اسم المستخدم في الواجهة
  document.getElementById('current-user').textContent = currentUser === 'mohammed' ? 'محمد' : 'سعد';
  
  // ألوان التضاريس
  const terrainColors = [
    'rgba(34, 139, 34, 0.7)',
    'rgba(34, 139, 34, 0.5)',
    'rgba(85, 107, 47, 0.6)',
    'rgba(107, 142, 35, 0.5)',
    'rgba(154, 205, 50, 0.4)'
  ];
  
  // توليد بذور عشوائية للجزر لضمان ثباتها
  const islandSeeds = [];
  for (let i = 0; i < numberOfIslands; i++) {
    islandSeeds.push(Math.random());
  }
  
  // تخزين بيانات القلاع لكل جزيرة
  let islandsData = [];
  
  // تخزين معلومات متوسط تقييم الجزر
  let islandAverageRatings = [];
  
  // دالة لتوليد رقم عشوائي ثابت باستخدام بذرة ثابتة
  function pseudoRandom(seed, index) {
    return (Math.sin(seed * 9999 + index * 999) * 10000) % 1;
  }
  
  // تنسيق التاريخ بطريقة سهلة القراءة
  function formatDate(timestamp) {
    if (!timestamp) return 'لم يتم التقييم بعد';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) {
      return 'الآن';
    } else if (diffMins < 60) {
      return `منذ ${diffMins} دقيقة`;
    } else if (diffHours < 24) {
      return `منذ ${diffHours} ساعة`;
    } else if (diffDays < 30) {
      return `منذ ${diffDays} يوم`;
    } else {
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
  }
  
  // وظيفة لحفظ البيانات على Firebase
  async function saveGameData() {
    // في وظيفة saveGameData، أضف هذه الأسطر في بداية الوظيفة
    console.log("بدء حفظ البيانات...");
    console.log("المستخدم الحالي:", currentUser);
    
    // بعد محاولة الحفظ إلى Firebase، أضف
    console.log("تم إرسال البيانات إلى Firebase");
    
    // في حالة الخطأ، أضف
    console.error("تفاصيل الخطأ:", error);
    
    // في وظيفة switchUser، أضف
    console.log("محاولة تبديل المستخدم من", currentUser);
    // إظهار مؤشر الحفظ
    saveIndicator.style.display = 'flex';
    saveMessage.textContent = 'جاري الحفظ...';
    saveIcon.className = 'save-icon';
    
    try {
      // تجميع البيانات
      const gameData = {
        islandsData: islandsData,
        islandAverageRatings: islandAverageRatings,
        settings: {
          yellowAlertMinutes: yellowAlertMinutes,
          redAlertMinutes: redAlertMinutes
        },
        lastUpdated: new Date().toISOString()
      };
      
      // حفظ البيانات محليًا كنسخة احتياطية
      localStorage.setItem(`islandsCastlesGame_${currentUser}`, JSON.stringify(gameData));
      
      // حفظ البيانات في Firebase
      await database.ref(`users/${currentUser}`).set(gameData);
      
      // تحديث مؤشر الحفظ بعد النجاح
      saveMessage.textContent = 'تم الحفظ بنجاح!';
      saveIcon.className = 'save-icon save-success';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 2000);
      
      return true;
    } catch (error) {
      console.error('خطأ في حفظ البيانات:', error);
      
      // تحديث مؤشر الحفظ بعد الفشل
      saveMessage.textContent = 'فشل الحفظ عبر الإنترنت! تم الحفظ محليًا';
      saveIcon.className = 'save-icon save-error';
      
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 3000);
      
      return false;
    }
  }
    
  // وظيفة لتحميل البيانات من Firebase
  async function loadGameData() {
    try {
      console.log(`محاولة تحميل بيانات المستخدم ${currentUser} من Firebase`);
      
      // محاولة تحميل البيانات من Firebase
      const snapshot = await database.ref(`users/${currentUser}`).once('value');
      const onlineData = snapshot.val();
      
      // محاولة الحصول على البيانات من التخزين المحلي كاحتياطي
      const savedData = localStorage.getItem(`islandsCastlesGame_${currentUser}`);
      let localData = null;
      
      if (savedData) {
        localData = JSON.parse(savedData);
        console.log(`تم تحميل بيانات المستخدم ${currentUser} من التخزين المحلي كاحتياطي`);
      }
      
      // إذا كانت البيانات موجودة عبر الإنترنت
      if (onlineData) {
        console.log(`تم تحميل بيانات المستخدم ${currentUser} من Firebase بنجاح`);
        
        // التحقق مما إذا كانت البيانات المحلية أحدث من البيانات عبر الإنترنت
        if (localData && localData.lastUpdated && 
            new Date(localData.lastUpdated) > new Date(onlineData.lastUpdated)) {
          console.log(`البيانات المحلية أحدث، استخدامها بدلاً من بيانات Firebase`);
          
          islandsData = localData.islandsData;
          islandAverageRatings = localData.islandAverageRatings;
          
          if (localData.settings) {
            yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
            redAlertMinutes = localData.settings.redAlertMinutes || 10;
            yellowAlertMinutesInput.value = yellowAlertMinutes;
            redAlertMinutesInput.value = redAlertMinutes;
          }
          
          // مزامنة البيانات المحلية الأحدث مع Firebase
          database.ref(`users/${currentUser}`).set(localData);
        } else {
          // استخدام البيانات من Firebase
          islandsData = onlineData.islandsData;
          islandAverageRatings = onlineData.islandAverageRatings;
          
          if (onlineData.settings) {
            yellowAlertMinutes = onlineData.settings.yellowAlertMinutes || 5;
            redAlertMinutes = onlineData.settings.redAlertMinutes || 10;
            yellowAlertMinutesInput.value = yellowAlertMinutes;
            redAlertMinutesInput.value = redAlertMinutes;
          }
          
          // تحديث التخزين المحلي
          localStorage.setItem(`islandsCastlesGame_${currentUser}`, JSON.stringify(onlineData));
        }
        
        return true;
      } 
      // إذا لم تكن البيانات موجودة عبر الإنترنت ولكن موجودة محليًا
      else if (localData) {
        console.log(`لا توجد بيانات عبر الإنترنت، استخدام البيانات المحلية`);
        
        islandsData = localData.islandsData;
        islandAverageRatings = localData.islandAverageRatings;
        
        if (localData.settings) {
          yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
          redAlertMinutes = localData.settings.redAlertMinutes || 10;
          yellowAlertMinutesInput.value = yellowAlertMinutes;
          redAlertMinutesInput.value = redAlertMinutes;
        }
        
        // رفع البيانات المحلية إلى Firebase
        database.ref(`users/${currentUser}`).set(localData);
        
        return true;
      }
      
      // لا توجد بيانات متاحة
      console.log(`لا توجد بيانات متاحة للمستخدم ${currentUser}`);
      return false;
    } catch (error) {
      console.error(`خطأ في تحميل بيانات ${currentUser}:`, error);
      
      // محاولة استخدام البيانات المحلية في حالة الفشل
      const savedData = localStorage.getItem(`islandsCastlesGame_${currentUser}`);
      if (savedData) {
        console.log(`استخدام البيانات المحلية بسبب فشل الاتصال بـ Firebase`);
        const localData = JSON.parse(savedData);
        
        islandsData = localData.islandsData;
        islandAverageRatings = localData.islandAverageRatings;
        
        if (localData.settings) {
          yellowAlertMinutes = localData.settings.yellowAlertMinutes || 5;
          redAlertMinutes = localData.settings.redAlertMinutes || 10;
          yellowAlertMinutesInput.value = yellowAlertMinutes;
          redAlertMinutesInput.value = redAlertMinutes;
        }
        
        return true;
      }
      
      return false;
    }
  }
    
  // تهيئة بيانات اللعبة
  function initializeGameData() {
    // محاولة تحميل البيانات المحفوظة
    const dataLoaded = loadGameData();
    
    // إذا لم توجد بيانات محفوظة، قم بإنشاء بيانات جديدة
    if (!dataLoaded) {
      for (let i = 0; i < numberOfIslands; i++) {
        const castlesCount = getCastlesCount(i);
        console.log(`تهيئة الجزيرة ${i+1} بعدد قلاع: ${castlesCount}`);
        
        // إنشاء مصفوفة لتخزين بيانات قلاع الجزيرة
        islandsData[i] = [];
        for (let j = 0; j < castlesCount; j++) {
          islandsData[i][j] = {
            rating: 0,
            evaluated: false,
            lastRated: null // وقت آخر تقييم
          };
        }
        
        // تهيئة متوسط التقييم
        islandAverageRatings[i] = {
          average: 0,
          evaluated: 0
        };
      }
    } 
    // التأكد من وجود خاصية lastRated وعدد صحيح من القلاع لكل جزيرة
    else {
      for (let i = 0; i < numberOfIslands; i++) {
        const castlesCount = getCastlesCount(i);
        console.log(`فحص الجزيرة ${i+1} بعدد قلاع: ${castlesCount}, الموجود: ${islandsData[i]?.length || 0}`);
        
        // تأكد من وجود مصفوفة لهذه الجزيرة
        if (!islandsData[i]) {
          islandsData[i] = [];
        }
        
        // تأكد من وجود العدد الصحيح من القلاع
        if (islandsData[i].length !== castlesCount) {
          console.log(`تصحيح عدد القلاع للجزيرة ${i+1}: من ${islandsData[i].length} إلى ${castlesCount}`);
          // إذا كان هناك قلاع أكثر، نقوم بحذف الزائدة
          while (islandsData[i].length > castlesCount) {
            islandsData[i].pop();
          }
          // إذا كان هناك قلاع أقل، نضيف الجديدة
          while (islandsData[i].length < castlesCount) {
            islandsData[i].push({
              rating: 0,
              evaluated: false,
              lastRated: null
            });
          }
        }
        
        // تأكد من وجود خاصية lastRated لكل قلعة
        for (let j = 0; j < castlesCount; j++) {
          if (!islandsData[i][j]) {
            islandsData[i][j] = {
              rating: 0,
              evaluated: false,
              lastRated: null
            };
          } else if (islandsData[i][j].lastRated === undefined) {
            islandsData[i][j].lastRated = null;
          }
        }
        
        // تأكد من وجود بيانات متوسط التقييم
        if (!islandAverageRatings[i]) {
          islandAverageRatings[i] = {
            average: 0,
            evaluated: 0
          };
        }
      }
    }
  }
</script>

<script>
  // حساب عدد القلاع التي تحتاج للمراجعة
  function countAlertCastles() {
    let yellowCount = 0;
    let redCount = 0;
    const now = Date.now();
    
    for (let i = 0; i < numberOfIslands; i++) {
      const castlesCount = getCastlesCount(i);
      
      for (let j = 0; j < castlesCount; j++) {
        const castleData = islandsData[i][j];
        if (!castleData.evaluated || !castleData.lastRated) continue;
        
        const lastRated = new Date(castleData.lastRated).getTime();
        const timeDiff = (now - lastRated) / (1000 * 60); // الفرق بالدقائق
        
        if (timeDiff >= redAlertMinutes) {
          redCount++;
        } else if (timeDiff >= yellowAlertMinutes) {
          yellowCount++;
        }
      }
    }
    
    return { yellowCount, redCount };
  }
  
  // حساب عدد القلاع التي تحتاج للمراجعة في جزيرة محددة
  function countIslandAlertCastles(islandId) {
    let yellowCount = 0;
    let redCount = 0;
    const now = Date.now();
    const castlesCount = getCastlesCount(islandId);
    
    for (let j = 0; j < castlesCount; j++) {
      const castleData = islandsData[islandId][j];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // الفرق بالدقائق
      
      if (timeDiff >= redAlertMinutes) {
        redCount++;
      } else if (timeDiff >= yellowAlertMinutes) {
        yellowCount++;
      }
    }
    
    return { yellowCount, redCount };
  }

  // فحص حالة تنبيهات التقييم لجميع القلاع
  function checkRatingAlerts() {
    if (currentIsland === null) return;
    
    const castlesCount = getCastlesCount(currentIsland);
    const now = Date.now();
    
    for (let i = 0; i < castlesCount; i++) {
      const castleData = islandsData[currentIsland][i];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // الفرق بالدقائق
      
      // إزالة أي علامات تنبيه موجودة
      const castle = document.querySelector(`.castle[data-castle-id="${i}"]`);
      if (!castle) continue;
      
      const existingAlert = castle.querySelector('.alert-icon');
      if (existingAlert) {
        castle.removeChild(existingAlert);
      }
      
      // إضافة علامة تنبيه جديدة إذا لزم الأمر
      if (timeDiff >= redAlertMinutes) { // مر وقت المراجعة العاجلة
        addAlertIcon(castle, 'red');
      } else if (timeDiff >= yellowAlertMinutes) { // مر وقت المراجعة العادية
        addAlertIcon(castle, 'yellow');
      }
    }
    
    // تحديث إحصائيات الجزيرة
    updateIslandStats();
  }
  
  // تحديث تنبيهات الجزر في الصفحة الرئيسية
  function updateIslandAlerts() {
    // مسح التنبيهات الموجودة
    document.querySelectorAll('.island .alert-icon').forEach(alert => {
      alert.remove();
    });
    
    // التحقق من كل جزيرة
    for (let i = 0; i < numberOfIslands; i++) {
      const island = document.querySelector(`.island[data-island-id="${i}"]`);
      if (!island) continue;
      
      const alertStatus = checkIslandAlertStatus(i);
      
      // إضافة علامات التنبيه حسب الحالة
      if (alertStatus.hasRed) {
        addIslandAlertIcon(island, 'red');
      }
      
      if (alertStatus.hasYellow) {
        addIslandAlertIcon(island, 'yellow');
      }
    }
  }
  
  // التحقق من حالة تنبيهات الجزيرة
  function checkIslandAlertStatus(islandId) {
    let hasYellow = false;
    let hasRed = false;
    const castlesCount = getCastlesCount(islandId);
    const now = Date.now();
    
    for (let j = 0; j < castlesCount; j++) {
      const castleData = islandsData[islandId][j];
      if (!castleData.evaluated || !castleData.lastRated) continue;
      
      const lastRated = new Date(castleData.lastRated).getTime();
      const timeDiff = (now - lastRated) / (1000 * 60); // الفرق بالدقائق
      
      if (timeDiff >= redAlertMinutes) {
        hasRed = true;
      } else if (timeDiff >= yellowAlertMinutes) {
        hasYellow = true;
      }
      
      // للتحسين: إذا وجدنا كلا النوعين من التنبيهات، نتوقف عن البحث
      if (hasRed && hasYellow) break;
    }
    
    return { hasYellow, hasRed };
  }
  
  // إضافة أيقونة تنبيه إلى القلعة
  function addAlertIcon(castle, color) {
    const alertIcon = document.createElement('div');
    alertIcon.className = `alert-icon alert-${color}`;
    alertIcon.textContent = '!';
    castle.appendChild(alertIcon);
  }
  
  // إضافة أيقونة تنبيه إلى الجزيرة
  function addIslandAlertIcon(island, color) {
    const alertIcon = document.createElement('div');
    alertIcon.className = `alert-icon alert-${color}`;
    alertIcon.textContent = '!';
    island.appendChild(alertIcon);
  }
  
  // إحصائيات التقييم العامة
  function updateGlobalStats() {
    let totalCastles = 0;
    let totalRatedCastles = 0;
    let totalRatingsSum = 0;
    
    // حساب إجمالي القلاع وعدد القلاع المُقيمة والمتوسط العام
    for (let i = 0; i < numberOfIslands; i++) {
      const castlesCount = getCastlesCount(i);
      totalCastles += castlesCount;
      
      if (islandAverageRatings[i]) {
        totalRatedCastles += islandAverageRatings[i].evaluated;
        totalRatingsSum += islandAverageRatings[i].average * islandAverageRatings[i].evaluated;
      }
    }
    
    // حساب المتوسط العام
    const globalAverage = totalRatedCastles > 0 ? totalRatingsSum / totalRatedCastles : 0;
    
    // تحديث العناصر في واجهة المستخدم
    totalCastlesElement.textContent = totalCastles;
    totalRatedCastlesElement.textContent = totalRatedCastles;
    globalRatingAverageElement.textContent = globalAverage.toFixed(1) + '%';
    
    // تغيير لون متوسط التقييم العام
    globalRatingAverageElement.style.color = getRatingColor(globalAverage);
    
    // تحديث إحصائيات التنبيهات
    const alertCounts = countAlertCastles();
    yellowAlertCountElement.textContent = alertCounts.yellowCount;
    redAlertCountElement.textContent = alertCounts.redCount;
    
    // تحديث تنبيهات الجزر
    updateIslandAlerts();
  }
  
  // تحديث إحصائيات الجزيرة الحالية
  function updateIslandStats() {
    if (currentIsland === null) return;
    
    // التأكد من الحصول على العدد الصحيح للقلاع
    const castlesCount = getCastlesCount(currentIsland);
    
    // إعادة حساب عدد القلاع المقيمة والمتوسط للتأكد من الدقة
    let evaluated = 0;
    let totalRatings = 0;
    
    // فحص البيانات والتأكد من وجود العدد الصحيح من القلاع
    if (!islandsData[currentIsland] || islandsData[currentIsland].length !== castlesCount) {
      // إذا كانت البيانات غير موجودة أو غير صحيحة، قم بإنشائها
      if (!islandsData[currentIsland]) {
        islandsData[currentIsland] = [];
      }
      
      // ضبط العدد الصحيح من القلاع
      while (islandsData[currentIsland].length < castlesCount) {
        islandsData[currentIsland].push({
          rating: 0,
          evaluated: false,
          lastRated: null
        });
      }
      
      while (islandsData[currentIsland].length > castlesCount) {
        islandsData[currentIsland].pop();
      }
    }
    
    // حساب عدد القلاع المقيمة والمتوسط
    for (let i = 0; i < castlesCount; i++) {
      if (islandsData[currentIsland][i].evaluated) {
        evaluated++;
        totalRatings += islandsData[currentIsland][i].rating;
      }
    }
    
    // حساب المتوسط
    const average = evaluated > 0 ? totalRatings / evaluated : 0;
    
    // تحديث بيانات متوسط الجزيرة
    if (!islandAverageRatings[currentIsland]) {
      islandAverageRatings[currentIsland] = { average: 0, evaluated: 0 };
    }
    
    islandAverageRatings[currentIsland].average = average;
    islandAverageRatings[currentIsland].evaluated = evaluated;
    
    // تحديث العناصر في واجهة المستخدم
    islandCastlesElement.textContent = castlesCount;
    islandRatedCastlesElement.textContent = evaluated;
    islandRatingAverageElement.textContent = average.toFixed(1) + '%';
    islandRatingAverageElement.style.color = getRatingColor(average);
    
    // تحديث أعداد التنبيهات
    const alertCounts = countIslandAlertCastles(currentIsland);
    islandYellowAlertCountElement.textContent = alertCounts.yellowCount;
    islandRedAlertCountElement.textContent = alertCounts.redCount;
    
    console.log(`تم تحديث إحصائيات الجزيرة ${currentIsland + 1}: العدد الكلي: ${castlesCount}، المقيمة: ${evaluated}، المتوسط: ${average.toFixed(1)}%`);
    
    // حفظ البيانات
    saveGameData();
  }
  
  // تحويل قيمة التقييم إلى لون بتدرج من الأحمر إلى الأخضر
  function getRatingColor(rating) {
    // تحديد اللون بناءً على التقييم
    if (rating >= 95) {
      return '#00FF00'; // أخضر ساطع عند 100%
    } else if (rating >= 75) {
      // تدرج من الأخضر الفاتح إلى الأصفر من 95% إلى 75%
      const green = 255;
      const red = 255 - Math.floor((rating - 75) * (255 / 20));
      return `rgb(${red}, ${green}, 0)`;
    } else if (rating >= 50) {
      // تدرج من الأصفر إلى البرتقالي من 75% إلى 50%
      const green = Math.floor((rating - 50) * (255 / 25));
      return `rgb(255, ${green}, 0)`;
    } else {
      // تدرج من البرتقالي إلى الأحمر من 50% إلى 0%
      const red = 255;
      const green = Math.floor(rating * 2.55);
      return `rgb(${red}, ${green}, 0)`;
    }
  }
  
  // توزيع القلاع في جميع أنحاء الجزيرة بشكل أفضل ومع مراعاة المسافات
  function distributeCastlesEvenly(containerWidth, containerHeight, numberOfCastles, castleWidth, castleHeight, islandId) {
    const containerRadius = Math.min(containerWidth, containerHeight) / 2;
    // تقليل نصف القطر للاحتفاظ بمسافة من الحافة
    const safeRadius = containerRadius * 0.95;
    const castlePositions = [];
    const minDistance = Math.max(castleWidth, castleHeight) * 1.0; // زيادة المسافة الدنيا بين القلاع
    
    // توزيع القلاع في دوائر متحدة المركز مع تباعدها بشكل متساوٍ
    const rings = 7; // عدد الحلقات
    
    // زيادة عدد المحاولات للعثور على مواقع مناسبة
    const maxAttempts = 100;
    
    // الاحتفاظ بعدد القلاع التي تم وضعها بنجاح
    let placedCastles = 0;
    
    // توزيع القلاع في كل حلقة
    for (let ring = 0; ring < rings && placedCastles < numberOfCastles; ring++) {
      // حساب نصف قطر الحلقة مع ترك مسافة كافية من الحافة
      const radiusMin = safeRadius * (0.15 + (ring * 0.85 / rings));
      const radiusMax = safeRadius * (0.15 + ((ring + 0.8) * 0.85 / rings));

      // عدد القلاع في هذه الحلقة يتناسب مع محيطها
      const ringRatio = (ring + 1) / rings;
      const castlesInRing = Math.min(
        Math.ceil(numberOfCastles * ringRatio * 0.7),
        numberOfCastles - placedCastles
      );
      
      // محاولة وضع القلاع في هذه الحلقة
      for (let i = 0; i < castlesInRing; i++) {
        let validPosition = false;
        let attempts = 0;
        let x, y;
        
        while (!validPosition && attempts < maxAttempts) {
          attempts++;
          
          // زاوية متباعدة بالتساوي مع إضافة عشوائية
          const baseAngle = (i / castlesInRing) * 2 * Math.PI;
          const angle = baseAngle + pseudoRandom(islandSeeds[islandId], 100 + ring * 30 + i) * 0.3;
          
          // نصف قطر ضمن نطاق الحلقة الحالية
          const radius = radiusMin + pseudoRandom(islandSeeds[islandId], 200 + ring * 30 + i) * (radiusMax - radiusMin);
          
          // موقع القلعة
          x = containerWidth/2 + radius * Math.cos(angle) - castleWidth/2;
          y = containerHeight/2 + radius * Math.sin(angle) - castleHeight/2;
          
          // التحقق من عدم تداخل القلعة مع القلاع الأخرى
          validPosition = true;
          for (const pos of castlePositions) {
            const dx = pos.x - x;
            const dy = pos.y - y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < minDistance) {
              validPosition = false;
              break;
            }
          }
        }
        
        if (validPosition) {
          castlePositions.push({ x, y });
          placedCastles++;
        }
      }
    }

    // في حالة عدم تمكن الخوارزمية من وضع كل القلاع، نحاول بطريقة أقل تقييدًا
    if (placedCastles < numberOfCastles) {
      const remainingCastles = numberOfCastles - placedCastles;
      
      for (let i = 0; i < remainingCastles; i++) {
        let validPosition = false;
        let attempts = 0;
        let x, y;
        
        while (!validPosition && attempts < maxAttempts) {
          attempts++;
          
          // موقع عشوائي ضمن الدائرة
          const radius = pseudoRandom(islandSeeds[islandId], 500 + i) * safeRadius;
          const angle = pseudoRandom(islandSeeds[islandId], 600 + i) * 2 * Math.PI;
          
          x = containerWidth/2 + radius * Math.cos(angle) - castleWidth/2;
          y = containerHeight/2 + radius * Math.sin(angle) - castleHeight/2;
          
          // اختبار التداخل مع مسافة أقل
          validPosition = true;
          for (const pos of castlePositions) {
            const dx = pos.x - x;
            const dy = pos.y - y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < minDistance * 0.8) { // تخفيض المسافة المطلوبة للقلاع المتبقية
              validPosition = false;
              break;
            }
          }
        }
        
        if (validPosition) {
          castlePositions.push({ x, y });
        }
      }
    }
    
    return castlePositions;
  }
  
  // عرض الجزيرة بالتفصيل
  function showDetailedIsland(islandId) {
    currentIsland = islandId;
    islandTitle.textContent = `الجزيرة ${islandId + 1}`;
    detailedView.style.display = 'block';
    
    // إزالة القلاع والتضاريس القديمة
    while (detailedGrass.firstChild) {
      detailedGrass.removeChild(detailedGrass.firstChild);
    }
    
    // إضافة طبقة الرمل
    const detailedSand = document.createElement('div');
    detailedSand.className = 'detailed-sand';
    
    // استخدام شكل الجزيرة نفسه من العرض الرئيسي
    const randomShape = `${45 + pseudoRandom(islandSeeds[islandId], 1) * 10}% ${50 + pseudoRandom(islandSeeds[islandId], 2) * 10}% ${40 + pseudoRandom(islandSeeds[islandId], 3) * 10}% ${48 + pseudoRandom(islandSeeds[islandId], 4) * 10}%`;
    detailedSand.style.borderRadius = randomShape;
    detailedGrass.style.borderRadius = randomShape;
    
    // إضافة طبقة الخضرة
    const detailedGreenery = document.createElement('div');
    detailedGreenery.className = 'detailed-greenery';
    detailedGreenery.style.borderRadius = randomShape;
    
    // تعيين اللون بنفس اللون المستخدم في العرض الرئيسي
    const hue = 100 + Math.floor(pseudoRandom(islandSeeds[islandId], 9) * 40);
    detailedGreenery.style.backgroundColor = `hsl(${hue}, ${60 + pseudoRandom(islandSeeds[islandId], 10) * 20}%, ${30 + pseudoRandom(islandSeeds[islandId], 11) * 15}%)`;
    
    // إضافة تضاريس
    for (let t = 0; t < 12; t++) {
      const terrain = document.createElement('div');
      terrain.className = 'detailed-terrain';
      terrain.style.width = Math.floor(15 + pseudoRandom(islandSeeds[islandId], 20 + t * 3) * 40) + '%';
      terrain.style.height = Math.floor(15 + pseudoRandom(islandSeeds[islandId], 21 + t * 3) * 40) + '%';
      terrain.style.left = Math.floor(pseudoRandom(islandSeeds[islandId], 22 + t * 3) * 80) + '%';
      terrain.style.top = Math.floor(pseudoRandom(islandSeeds[islandId], 23 + t * 3) * 80) + '%';
      terrain.style.backgroundColor = terrainColors[Math.floor(pseudoRandom(islandSeeds[islandId], 24 + t) * terrainColors.length)];
      terrain.style.borderRadius = `${30 + pseudoRandom(islandSeeds[islandId], 25 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 26 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 27 + t * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 28 + t * 3) * 20}%`;
      detailedGreenery.appendChild(terrain);
    }
    
    // إضافة صخور عشوائية
    for (let r = 0; r < 6; r++) {
      const rock = document.createElement('div');
      rock.className = 'detailed-rock';
      rock.style.width = Math.floor(3 + pseudoRandom(islandSeeds[islandId], 50 + r * 3) * 8) + '%';
      rock.style.height = Math.floor(3 + pseudoRandom(islandSeeds[islandId], 51 + r * 3) * 8) + '%';
      rock.style.left = Math.floor(pseudoRandom(islandSeeds[islandId], 52 + r * 3) * 90) + '%';
      rock.style.top = Math.floor(pseudoRandom(islandSeeds[islandId], 53 + r * 3) * 90) + '%';
      rock.style.borderRadius = `${30 + pseudoRandom(islandSeeds[islandId], 54 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 55 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 56 + r * 3) * 20}% ${30 + pseudoRandom(islandSeeds[islandId], 57 + r * 3) * 20}%`;
      detailedSand.appendChild(rock);
    }
    
    detailedSand.appendChild(detailedGreenery);
    detailedGrass.appendChild(detailedSand);
    
    // عدد القلاع لهذه الجزيرة
    const castlesCount = getCastlesCount(islandId);
    console.log(`عرض الجزيرة ${islandId+1} بعدد قلاع: ${castlesCount}`);
    
    // إنشاء القلاع على الجزيرة
    const containerWidth = detailedGrass.offsetWidth || 800;
    const containerHeight = detailedGrass.offsetHeight || 600;
    const castleWidth = 40;
    const castleHeight = 60;
    
    // توزيع القلاع بشكل أفضل في جميع أنحاء الجزيرة
    const castlePositions = distributeCastlesEvenly(
      containerWidth, 
      containerHeight, 
      castlesCount, 
      castleWidth, 
      castleHeight,
      islandId
    );
    
    // تأكد من وجود بيانات لجميع القلاع
    while (islandsData[islandId].length < castlesCount) {
      islandsData[islandId].push({
        rating: 0,
        evaluated: false,
        lastRated: null
      });
    }
    
    // إنشاء القلاع بالعدد الصحيح
    for (let i = 0; i < castlesCount; i++) {
      const pos = castlePositions[i];
      
      const castle = document.createElement('div');
      castle.className = 'castle';
      castle.dataset.castleId = i;
      castle.style.left = pos.x + 'px';
      castle.style.top = pos.y + 'px';
      
      // إضافة باب للقلعة
      const door = document.createElement('div');
      door.className = 'castle-door';
      castle.appendChild(door);
      
      // إضافة إطار للقلعة
      const border = document.createElement('div');
      border.className = 'castle-border';
      border.id = `castle-border-${i}`;
      castle.appendChild(border);
      
      // إضافة رقم القلعة
      const castleNumber = document.createElement('div');
      castleNumber.className = 'castle-number';
      // حساب رقم القلعة حسب الترتيب المطلوب
      let castleGlobalNumber = 1;
      // حساب عدد القلاع في الجزر السابقة
      for (let j = 0; j < islandId; j++) {
        castleGlobalNumber += getCastlesCount(j);
      }
      castleGlobalNumber += i;
      castleNumber.textContent = castleGlobalNumber;
      castle.appendChild(castleNumber);
      
      // إضافة عنصر لعرض نسبة التقييم
      const ratingDisplay = document.createElement('div');
      ratingDisplay.className = 'castle-rating';
      ratingDisplay.id = `castle-rating-${i}`;
      
      // إظهار التقييم السابق إذا كان موجودًا
      if (islandsData[currentIsland][i].evaluated) {
        const rating = islandsData[currentIsland][i].rating;
        ratingDisplay.textContent = rating + '%';
        updateCastleBorder(border, rating);
        
        // إضافة علامة تنبيه إذا مضى وقت طويل على التقييم
        const lastRated = new Date(islandsData[currentIsland][i].lastRated).getTime();
        const now = Date.now();
        const timeDiff = (now - lastRated) / (1000 * 60); // الفرق بالدقائق
        
        if (timeDiff >= redAlertMinutes) { // مر وقت المراجعة العاجلة
          addAlertIcon(castle, 'red');
        } else if (timeDiff >= yellowAlertMinutes) { // مر وقت المراجعة العادية
          addAlertIcon(castle, 'yellow');
        }
      } else {
        ratingDisplay.textContent = 'لم يُقيّم';
      }
      
      castle.appendChild(ratingDisplay);
      
      // إضافة حدث النقر على القلعة
      castle.addEventListener('click', function() {
        selectedCastle = this;
        const castleId = parseInt(this.dataset.castleId);
        
        // تعيين القيمة الحالية للتقييم
        const currentRating = islandsData[currentIsland][castleId].evaluated 
          ? islandsData[currentIsland][castleId].rating 
          : 50;
        
        ratingSlider.value = currentRating;
        scoreDisplay.textContent = currentRating + '%';

        // عرض رقم القلعة في نافذة التقييم
        castleNumberDisplayElement.textContent = `القلعة رقم: ${parseInt(castle.querySelector('.castle-number').textContent)}`;
        
        // عرض وقت آخر تقييم إذا وجد
        if (islandsData[currentIsland][castleId].lastRated) {
          ratingTimeElement.textContent = `آخر تقييم: ${formatDate(islandsData[currentIsland][castleId].lastRated)}`;
        } else {
          ratingTimeElement.textContent = 'لم يتم التقييم بعد';
        }
        
        ratingModal.style.display = 'block';
        overlay.style.display = 'block';
      });
      
      detailedGrass.appendChild(castle);
    }
    
    // تحديث إحصائيات الجزيرة
    setTimeout(updateIslandStats, 100);  // تأخير قصير لضمان الانتهاء من إنشاء العناصر
    
    // بدء فحص تنبيهات التقييم
    if (alertCheckInterval) {
      clearInterval(alertCheckInterval);
    }
    alertCheckInterval = setInterval(checkRatingAlerts, 60000);
    
    // فحص فوري للتنبيهات
    checkRatingAlerts();
  }
  
  // تحديث حالة الإطار بناءً على التقييم
  function updateCastleBorder(borderElement, rating) {
    // تحديد لون الإطار بناءً على التقييم
    borderElement.style.borderColor = getRatingColor(rating);
  }
  
  // تحديث معلومات الجزيرة في الشاشة الرئيسية
  function updateIslandInfo() {
    for (let i = 0; i < numberOfIslands; i++) {
      const infoElement = document.getElementById(`island-info-${i}`);
      const borderElement = document.getElementById(`island-border-${i}`);
      
      const totalCastles = getCastlesCount(i);
      const evaluated = islandAverageRatings[i].evaluated;
      const average = islandAverageRatings[i].average;
      
      infoElement.textContent = `${evaluated}/${totalCastles} (${average.toFixed(1)}%)`;
      
      // تحديد لون إطار الجزيرة إذا تم تقييم أي قلعة
      if (evaluated > 0) {
        borderElement.style.borderColor = getRatingColor(average);
      }
    }
    
    // تحديث إحصائيات التقييم العامة أيضًا
    updateGlobalStats();
  }
  
   // تبديل المستخدم
  async function switchUser() {
    // حفظ البيانات الحالية
    await saveGameData();
    
    // تبديل المستخدم
    currentUser = currentUser === 'mohammed' ? 'saad' : 'mohammed';
    
    // تحديث localStorage
    localStorage.setItem('selectedUser', currentUser);
    
    // إعادة تحميل الصفحة
    window.location.reload();
  }
    
  // تحسين عرض القلاع
  function enhanceCastleDisplay() {
    const castleElements = document.querySelectorAll('.castle');
    
    castleElements.forEach((castle, index) => {
      // تنويع ألوان القلاع باستخدام بذرة ثابتة
      const islandId = currentIsland;
      const castleId = parseInt(castle.dataset.castleId);
      
      const baseHue = 10 + Math.floor(pseudoRandom(islandSeeds[islandId], 300 + castleId * 3) * 40);
      const baseSaturation = 10 + Math.floor(pseudoRandom(islandSeeds[islandId], 301 + castleId * 3) * 20);
      const baseLightness = 40 + Math.floor(pseudoRandom(islandSeeds[islandId], 302 + castleId * 3) * 30);
      
      castle.style.backgroundColor = `hsl(${baseHue}, ${baseSaturation}%, ${baseLightness}%)`;
      
      // تحسين أبواب القلاع
      const door = castle.querySelector('.castle-door');
      if (door) {
        door.style.backgroundColor = `hsl(${baseHue}, ${baseSaturation + 20}%, ${baseLightness - 20}%)`;
        
        // إضافة مقبض للباب
        const doorHandle = document.createElement('div');
        doorHandle.style.position = 'absolute';
        doorHandle.style.width = '2px';
        doorHandle.style.height = '2px';
        doorHandle.style.backgroundColor = '#FFD700';
        doorHandle.style.borderRadius = '50%';
        doorHandle.style.top = '10px';
        doorHandle.style.right = '2px';
        door.appendChild(doorHandle);
      }
      
      // إضافة تأثيرات نوافذ القلعة
      const windowCount = Math.floor(pseudoRandom(islandSeeds[islandId], 400 + castleId) * 3) + 1;
      for (let i = 0; i < windowCount; i++) {
        const castleWindow = document.createElement('div');
        castleWindow.style.position = 'absolute';
        castleWindow.style.width = '6px';
        castleWindow.style.height = '8px';
        castleWindow.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        castleWindow.style.borderRadius = '2px';
        castleWindow.style.top = `${15 + i * 15}px`;
        castleWindow.style.left = `${10 + pseudoRandom(islandSeeds[islandId], 401 + castleId + i) * 20}px`;
        castle.appendChild(castleWindow);
      }
    });
  }
  
  // إنشاء الجزر
  for (let i = 0; i < numberOfIslands; i++) {
    const island = document.createElement('div');
    island.className = 'island';
    island.dataset.islandId = i;
    
    const islandBase = document.createElement('div');
    islandBase.className = 'island-base';
    
    // إضافة تموجات الماء
    for (let r = 0; r < 3; r++) {
      const ripple = document.createElement('div');
      ripple.className = 'water-ripple';
      ripple.style.width = (100 + r * 10) + '%';
      ripple.style.height = (100 + r * 10) + '%';
      ripple.style.top = (-5 * r) + '%';
      ripple.style.left = (-5 * r) + '%';
      ripple.style.animation = `ripple ${2 + r * 0.5}s infinite alternate-reverse ease-in-out`;
      islandBase.appendChild(ripple);
    }
    
    // إنشاء قاعدة الجزيرة باستخدام البذرة الثابتة
    const grass = document.createElement('div');
    grass.className = 'island-grass';
    
    // إضافة طبقة الرمل
    const sand = document.createElement('div');
    sand.className = 'sand';
    
    // إضافة طبقة الخضرة
    const greenery = document.createElement('div');
    greenery.className = 'greenery';
    
    // إضافة تغييرات عشوائية ولكن ثابتة لشكل الجزيرة
    const randomShape = `${45 + pseudoRandom(islandSeeds[i], 1) * 10}% ${50 + pseudoRandom(islandSeeds[i], 2) * 10}% ${40 + pseudoRandom(islandSeeds[i], 3) * 10}% ${48 + pseudoRandom(islandSeeds[i], 4) * 10}%`;
    grass.style.borderRadius = randomShape;
    sand.style.borderRadius = randomShape;
    greenery.style.borderRadius = randomShape;
    
    // إضافة ظلال وتأثيرات عمق إضافية
    grass.style.boxShadow = `inset 0 0 ${10 + Math.floor(pseudoRandom(islandSeeds[i], 5) * 15)}px rgba(0, 0, 0, ${0.3 + pseudoRandom(islandSeeds[i], 6) * 0.2})`;
    sand.style.boxShadow = `inset 0 0 ${5 + Math.floor(pseudoRandom(islandSeeds[i], 7) * 10)}px rgba(101, 67, 33, ${0.4 + pseudoRandom(islandSeeds[i], 8) * 0.2})`;
    
    // إضافة تدرجات لونية للجزيرة
    const hue = 100 + Math.floor(pseudoRandom(islandSeeds[i], 9) * 40); // تنوع في اللون الأخضر
    greenery.style.backgroundColor = `hsl(${hue}, ${60 + pseudoRandom(islandSeeds[i], 10) * 20}%, ${30 + pseudoRandom(islandSeeds[i], 11) * 15}%)`;
    
    // إضافة تضاريس عشوائية (مناطق خضراء مختلفة الظلال)
    for (let t = 0; t < 7; t++) {
      const terrain = document.createElement('div');
      terrain.className = 'terrain';
      terrain.style.width = Math.floor(15 + pseudoRandom(islandSeeds[i], 20 + t * 3) * 30) + '%';
      terrain.style.height = Math.floor(15 + pseudoRandom(islandSeeds[i], 21 + t * 3) * 30) + '%';
      terrain.style.left = Math.floor(pseudoRandom(islandSeeds[i], 22 + t * 3) * 70) + '%';
      terrain.style.top = Math.floor(pseudoRandom(islandSeeds[i], 23 + t * 3) * 70) + '%';
      terrain.style.backgroundColor = terrainColors[Math.floor(pseudoRandom(islandSeeds[i], 24 + t) * terrainColors.length)];
      greenery.appendChild(terrain);
    }
    
    // إضافة صخور عشوائية
    for (let r = 0; r < 3; r++) {
      const rock = document.createElement('div');
      rock.className = 'rock';
      rock.style.width = Math.floor(5 + pseudoRandom(islandSeeds[i], 50 + r * 3) * 10) + '%';
      rock.style.height = Math.floor(5 + pseudoRandom(islandSeeds[i], 51 + r * 3) * 10) + '%';
      rock.style.left = Math.floor(pseudoRandom(islandSeeds[i], 52 + r * 3) * 90) + '%';
      rock.style.top = Math.floor(pseudoRandom(islandSeeds[i], 53 + r * 3) * 90) + '%';
      sand.appendChild(rock);
    }
    
    const number = document.createElement('div');
    number.className = 'island-number';
    number.textContent = (i + 1);
    
    // إضافة عنصر لعرض معلومات التقييم
    const info = document.createElement('div');
    info.className = 'island-info';
    info.id = `island-info-${i}`;
    
    const evaluated = islandAverageRatings[i]?.evaluated || 0;
    const average = islandAverageRatings[i]?.average || 0;
    const totalCastles = getCastlesCount(i);
    info.textContent = `${evaluated}/${totalCastles} (${average.toFixed(1)}%)`;
    
    // إضافة عنصر للإطار
    const border = document.createElement('div');
    border.className = 'island-border';
    border.id = `island-border-${i}`;
    
    // إظهار لون الإطار إذا كان هناك تقييمات
    if (evaluated > 0) {
      border.style.borderColor = getRatingColor(average);
    }
    
    grass.appendChild(sand);
    sand.appendChild(greenery);
    islandBase.appendChild(grass);
    island.appendChild(islandBase);
    island.appendChild(number);
    island.appendChild(info);
    island.appendChild(border);
    
    // إضافة حدث النقر على الجزيرة
    island.addEventListener('click', function() {
      showDetailedIsland(i);
    });
    
    islandsContainer.appendChild(island);
  }
  
  // تهيئة بيانات اللعبة
  initializeGameData();
  
  // تحديث إحصائيات التقييم العامة
  updateGlobalStats();
  
  // تغيير عرض نسبة التقييم مع تحريك السليدر
  ratingSlider.addEventListener('input', function() {
    scoreDisplay.textContent = this.value + '%';
  });
  
  // إلغاء تقييم القلعة
  cancelButton.addEventListener('click', function() {
    if (selectedCastle) {
      const castleId = parseInt(selectedCastle.dataset.castleId);
      const castleData = islandsData[currentIsland][castleId];
      
      // إذا كانت القلعة مُقيمة بالفعل
      if (castleData.evaluated) {
        const oldRating = castleData.rating;
        
        // تحديث بيانات القلعة
        castleData.evaluated = false;
        castleData.rating = 0;
        castleData.lastRated = null;
        
        // تحديث متوسط تقييم الجزيرة
        const islandData = islandAverageRatings[currentIsland];
        
        // التأكد من عدم القسمة على صفر
        if (islandData.evaluated > 1) {
          islandData.average = ((islandData.average * islandData.evaluated) - oldRating) / (islandData.evaluated - 1);
        } else {
          islandData.average = 0;
        }
        
        islandData.evaluated--;
        
        // تحديث عرض القلعة
        const borderElement = document.getElementById(`castle-border-${castleId}`);
        const ratingElement = document.getElementById(`castle-rating-${castleId}`);
        
        borderElement.style.borderColor = 'transparent';
        ratingElement.textContent = 'لم يُقيّم';
        
        // إزالة أي علامات تنبيه
        const alertIcon = selectedCastle.querySelector('.alert-icon');
        if (alertIcon) {
          selectedCastle.removeChild(alertIcon);
        }
        
        // تحديث إحصائيات الجزيرة
        updateIslandStats();
        
        // تحديث إطار الجزيرة
        const islandBorderElement = document.getElementById(`island-border-${currentIsland}`);
        if (islandData.evaluated > 0) {
          islandBorderElement.style.borderColor = getRatingColor(islandData.average);
        } else {
          islandBorderElement.style.borderColor = 'transparent';
        }
        
        // حفظ البيانات
        saveGameData();
        
        // تحديث إحصائيات التقييم العامة
        updateGlobalStats();
      }
      
      // إغلاق النافذة المنبثقة
      ratingModal.style.display = 'none';
      overlay.style.display = 'none';
      selectedCastle = null;
    }
  });
  
  // زر إغلاق نافذة التقييم
  closeRatingButton.addEventListener('click', function() {
    ratingModal.style.display = 'none';
    overlay.style.display = 'none';
    selectedCastle = null;
  });

  // تأكيد التقييم
  submitButton.addEventListener('click', function() {
    if (selectedCastle) {
      const castleId = parseInt(selectedCastle.dataset.castleId);
      const rating = parseInt(ratingSlider.value);
      const borderElement = document.getElementById(`castle-border-${castleId}`);
      const ratingElement = document.getElementById(`castle-rating-${castleId}`);
      
      // تحديث بيانات القلعة
      const castleData = islandsData[currentIsland][castleId];
      const oldRating = castleData.rating;
      const wasEvaluated = castleData.evaluated;
      
      castleData.rating = rating;
      castleData.evaluated = true;
      castleData.lastRated = Date.now(); // تسجيل وقت التقييم
      
      // تحديث عرض تقييم القلعة
      ratingElement.textContent = rating + '%';
      
      // تحديث إطار القلعة
      updateCastleBorder(borderElement, rating);
      
      // إزالة أي علامات تنبيه موجودة
      const alertIcon = selectedCastle.querySelector('.alert-icon');
      if (alertIcon) {
        selectedCastle.removeChild(alertIcon);
      }
      
      // تحديث متوسط تقييم الجزيرة
      const islandData = islandAverageRatings[currentIsland];
      
      if (!wasEvaluated) {
        // أول تقييم للقلعة
        islandData.evaluated++;
        islandData.average = ((islandData.average * (islandData.evaluated - 1)) + rating) / islandData.evaluated;
      } else {
        // تعديل تقييم سابق
        islandData.average = ((islandData.average * islandData.evaluated) - oldRating + rating) / islandData.evaluated;
      }
      
      // تحديث إحصائيات الجزيرة
      updateIslandStats();
      
      // تحديث إطار الجزيرة الحالية
      const islandBorderElement = document.getElementById(`island-border-${currentIsland}`);
      islandBorderElement.style.borderColor = getRatingColor(islandData.average);
      
      // حفظ البيانات
      saveGameData();
      
      // تحديث إحصائيات التقييم العامة
      updateGlobalStats();
      
      // إغلاق النافذة المنبثقة
      ratingModal.style.display = 'none';
      overlay.style.display = 'none';
      selectedCastle = null;
    }
  });
  
  // زر العودة
  backButton.addEventListener('click', function() {
    detailedView.style.display = 'none';
    currentIsland = null;
    
    // إيقاف فاصل التحقق من التنبيهات
    if (alertCheckInterval) {
      clearInterval(alertCheckInterval);
      alertCheckInterval = null;
    }
    
    // تحديث معلومات الجزر في الشاشة الرئيسية
    updateIslandInfo();
  });
  
  // زر تبديل المستخدم
  switchUserButton.addEventListener('click', function() {
    switchUser();
  });
  
  // إعدادات التنبيهات
  settingsButton.addEventListener('click', function() {
    // ضبط القيم الحالية في نموذج الإعدادات
    yellowAlertMinutesInput.value = yellowAlertMinutes;
    redAlertMinutesInput.value = redAlertMinutes;
    
    // إظهار نافذة الإعدادات
    settingsModal.style.display = 'block';
    overlay.style.display = 'block';
  });
  
  // إغلاق نافذة الإعدادات
  closeSettingsButton.addEventListener('click', function() {
    settingsModal.style.display = 'none';
    overlay.style.display = 'none';
  });
  
  // حفظ الإعدادات
  saveSettingsButton.addEventListener('click', function() {
    // التحقق من صحة القيم
    const yellowMinutes = parseInt(yellowAlertMinutesInput.value);
    const redMinutes = parseInt(redAlertMinutesInput.value);
    
    if (yellowMinutes > 0 && redMinutes > 0 && redMinutes > yellowMinutes) {
      yellowAlertMinutes = yellowMinutes;
      redAlertMinutes = redMinutes;
      
      // حفظ الإعدادات
      saveGameData();
      
      // تحديث التنبيهات
      updateGlobalStats();
      if (currentIsland !== null) {
        checkRatingAlerts();
      }
      
      // إغلاق النافذة
      settingsModal.style.display = 'none';
      overlay.style.display = 'none';
    } else {
      // إظهار رسالة خطأ إذا كانت القيم غير صحيحة
      alert('يجب أن تكون مدة المراجعة العاجلة أكبر من مدة المراجعة العادية وكلاهما أكبر من صفر');
    }
  });
  
  // تنفيذ تحسينات الرسوميات عند تحميل الصفحة وعند عرض جزيرة تفصيلية
  window.addEventListener('load', function() {
    // تحديث إحصائيات التقييم العامة عند بدء التشغيل
    updateGlobalStats();
    
    // يتم عرض التفاصيل الإضافية في العرض المفصل فقط
    document.addEventListener('click', function() {
      if (currentIsland !== null) {
        setTimeout(enhanceCastleDisplay, 100);
      }
    });
  });
</script>
